import{r as i,g as ze,f as qe,h as Ue,_ as Ye,i as B,j as e,s as je,k as Re,l as He,m as Ze,aR as Io,Q as Do,a0 as No,a7 as _o,I as Po,a1 as Lo,a2 as Fo,D as Mo,au as bo,A as vo,B as be,a9 as $o,b as Xe,C as To,af as Eo,T as he,G as g,F as Oe,q as Be,S as We,M as ge,c as w,P as xo,w as Ro,a8 as So,aS as Ao,y as jo,E as A}from"./index-D2WH0i0l.js";import{G as Oo}from"./GenericList-CZICF8vs.js";import{D as Bo}from"./DetailModal-BVuqfkLW.js";import{E as to}from"./EventNote-C1bQThfN.js";import{I as Te}from"./InputAdornment-RiOQfDiX.js";import{F as Wo}from"./FormControlLabel-CLvj0mWI.js";import{C as ko}from"./Checkbox-4ec6YfyB.js";import{A as Vo}from"./Autocomplete-CRX_95Jf.js";import{S as zo}from"./Search-CIHESQ8V.js";import{C as Co}from"./ConfirmationDialog-BkQTGDdL.js";import"./NavigateNext-C2-Nd8B6.js";import"./TableRow-CTBWTERd.js";import"./Stack-BupWGgAE.js";import"./usePreviousProps-C0i_9UfY.js";const Qe=i.createContext({}),no=i.createContext({});function qo(a){return ze("MuiStep",a)}qe("MuiStep",["root","horizontal","vertical","alternativeLabel","completed"]);const Uo=["active","children","className","component","completed","disabled","expanded","index","last"],Yo=a=>{const{classes:n,orientation:h,alternativeLabel:m,completed:x}=a;return He({root:["root",h,m&&"alternativeLabel",x&&"completed"]},qo,n)},Ho=je("div",{name:"MuiStep",slot:"Root",overridesResolver:(a,n)=>{const{ownerState:h}=a;return[n.root,n[h.orientation],h.alternativeLabel&&n.alternativeLabel,h.completed&&n.completed]}})(({ownerState:a})=>B({},a.orientation==="horizontal"&&{paddingLeft:8,paddingRight:8},a.alternativeLabel&&{flex:1,position:"relative"})),ke=i.forwardRef(function(n,h){const m=Ue({props:n,name:"MuiStep"}),{active:x,children:D,className:$,component:F="div",completed:M,disabled:q,expanded:b=!1,index:N,last:P}=m,re=Ye(m,Uo),{activeStep:c,connector:W,alternativeLabel:pe,orientation:de,nonLinear:le}=i.useContext(Qe);let[p=!1,y=!1,ae=!1]=[x,M,q];c===N?p=x!==void 0?x:!0:!le&&c>N?y=M!==void 0?M:!0:!le&&c<N&&(ae=q!==void 0?q:!0);const K=i.useMemo(()=>({index:N,last:P,expanded:b,icon:N+1,active:p,completed:y,disabled:ae}),[N,P,b,p,y,ae]),J=B({},m,{active:p,orientation:de,alternativeLabel:pe,completed:y,disabled:ae,expanded:b,component:F}),ue=Yo(J),ce=e.jsxs(Ho,B({as:F,className:Re(ue.root,$),ref:h,ownerState:J},re,{children:[W&&pe&&N!==0?W:null,D]}));return e.jsx(no.Provider,{value:K,children:W&&!pe&&N!==0?e.jsxs(i.Fragment,{children:[W,ce]}):ce})}),Go=Ze(e.jsx("path",{d:"M12 0a12 12 0 1 0 0 24 12 12 0 0 0 0-24zm-2 17l-5-5 1.4-1.4 3.6 3.6 7.6-7.6L19 8l-9 9z"}),"CheckCircle"),Jo=Ze(e.jsx("path",{d:"M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"}),"Warning");function Xo(a){return ze("MuiStepIcon",a)}const ro=qe("MuiStepIcon",["root","active","completed","error","text"]);var wo;const Zo=["active","className","completed","error","icon"],Qo=a=>{const{classes:n,active:h,completed:m,error:x}=a;return He({root:["root",h&&"active",m&&"completed",x&&"error"],text:["text"]},Xo,n)},ao=je(Io,{name:"MuiStepIcon",slot:"Root",overridesResolver:(a,n)=>n.root})(({theme:a})=>({display:"block",transition:a.transitions.create("color",{duration:a.transitions.duration.shortest}),color:(a.vars||a).palette.text.disabled,[`&.${ro.completed}`]:{color:(a.vars||a).palette.primary.main},[`&.${ro.active}`]:{color:(a.vars||a).palette.primary.main},[`&.${ro.error}`]:{color:(a.vars||a).palette.error.main}})),Ko=je("text",{name:"MuiStepIcon",slot:"Text",overridesResolver:(a,n)=>n.text})(({theme:a})=>({fill:(a.vars||a).palette.primary.contrastText,fontSize:a.typography.caption.fontSize,fontFamily:a.typography.fontFamily})),et=i.forwardRef(function(n,h){const m=Ue({props:n,name:"MuiStepIcon"}),{active:x=!1,className:D,completed:$=!1,error:F=!1,icon:M}=m,q=Ye(m,Zo),b=B({},m,{active:x,completed:$,error:F}),N=Qo(b);if(typeof M=="number"||typeof M=="string"){const P=Re(D,N.root);return F?e.jsx(ao,B({as:Jo,className:P,ref:h,ownerState:b},q)):$?e.jsx(ao,B({as:Go,className:P,ref:h,ownerState:b},q)):e.jsxs(ao,B({className:P,ref:h,ownerState:b},q,{children:[wo||(wo=e.jsx("circle",{cx:"12",cy:"12",r:"12"})),e.jsx(Ko,{className:N.text,x:"12",y:"12",textAnchor:"middle",dominantBaseline:"central",ownerState:b,children:M})]}))}return M});function ot(a){return ze("MuiStepLabel",a)}const Ne=qe("MuiStepLabel",["root","horizontal","vertical","label","active","completed","error","disabled","iconContainer","alternativeLabel","labelContainer"]),tt=["children","className","componentsProps","error","icon","optional","slotProps","StepIconComponent","StepIconProps"],rt=a=>{const{classes:n,orientation:h,active:m,completed:x,error:D,disabled:$,alternativeLabel:F}=a;return He({root:["root",h,D&&"error",$&&"disabled",F&&"alternativeLabel"],label:["label",m&&"active",x&&"completed",D&&"error",$&&"disabled",F&&"alternativeLabel"],iconContainer:["iconContainer",m&&"active",x&&"completed",D&&"error",$&&"disabled",F&&"alternativeLabel"],labelContainer:["labelContainer",F&&"alternativeLabel"]},ot,n)},at=je("span",{name:"MuiStepLabel",slot:"Root",overridesResolver:(a,n)=>{const{ownerState:h}=a;return[n.root,n[h.orientation]]}})(({ownerState:a})=>B({display:"flex",alignItems:"center",[`&.${Ne.alternativeLabel}`]:{flexDirection:"column"},[`&.${Ne.disabled}`]:{cursor:"default"}},a.orientation==="vertical"&&{textAlign:"left",padding:"8px 0"})),nt=je("span",{name:"MuiStepLabel",slot:"Label",overridesResolver:(a,n)=>n.label})(({theme:a})=>B({},a.typography.body2,{display:"block",transition:a.transitions.create("color",{duration:a.transitions.duration.shortest}),[`&.${Ne.active}`]:{color:(a.vars||a).palette.text.primary,fontWeight:500},[`&.${Ne.completed}`]:{color:(a.vars||a).palette.text.primary,fontWeight:500},[`&.${Ne.alternativeLabel}`]:{marginTop:16},[`&.${Ne.error}`]:{color:(a.vars||a).palette.error.main}})),it=je("span",{name:"MuiStepLabel",slot:"IconContainer",overridesResolver:(a,n)=>n.iconContainer})(()=>({flexShrink:0,display:"flex",paddingRight:8,[`&.${Ne.alternativeLabel}`]:{paddingRight:0}})),st=je("span",{name:"MuiStepLabel",slot:"LabelContainer",overridesResolver:(a,n)=>n.labelContainer})(({theme:a})=>({width:"100%",color:(a.vars||a).palette.text.secondary,[`&.${Ne.alternativeLabel}`]:{textAlign:"center"}})),Ee=i.forwardRef(function(n,h){var m;const x=Ue({props:n,name:"MuiStepLabel"}),{children:D,className:$,componentsProps:F={},error:M=!1,icon:q,optional:b,slotProps:N={},StepIconComponent:P,StepIconProps:re}=x,c=Ye(x,tt),{alternativeLabel:W,orientation:pe}=i.useContext(Qe),{active:de,disabled:le,completed:p,icon:y}=i.useContext(no),ae=q||y;let K=P;ae&&!K&&(K=et);const J=B({},x,{active:de,alternativeLabel:W,completed:p,disabled:le,error:M,orientation:pe}),ue=rt(J),ce=(m=N.label)!=null?m:F.label;return e.jsxs(at,B({className:Re(ue.root,$),ref:h,ownerState:J},c,{children:[ae||K?e.jsx(it,{className:ue.iconContainer,ownerState:J,children:e.jsx(K,B({completed:p,active:de,error:M,icon:ae},re))}):null,e.jsxs(st,{className:ue.labelContainer,ownerState:J,children:[D?e.jsx(nt,B({ownerState:J},ce,{className:Re(ue.label,ce==null?void 0:ce.className),children:D})):null,b]})]}))});Ee.muiName="StepLabel";function lt(a){return ze("MuiStepConnector",a)}qe("MuiStepConnector",["root","horizontal","vertical","alternativeLabel","active","completed","disabled","line","lineHorizontal","lineVertical"]);const ct=["className"],dt=a=>{const{classes:n,orientation:h,alternativeLabel:m,active:x,completed:D,disabled:$}=a,F={root:["root",h,m&&"alternativeLabel",x&&"active",D&&"completed",$&&"disabled"],line:["line",`line${Do(h)}`]};return He(F,lt,n)},ut=je("div",{name:"MuiStepConnector",slot:"Root",overridesResolver:(a,n)=>{const{ownerState:h}=a;return[n.root,n[h.orientation],h.alternativeLabel&&n.alternativeLabel,h.completed&&n.completed]}})(({ownerState:a})=>B({flex:"1 1 auto"},a.orientation==="vertical"&&{marginLeft:12},a.alternativeLabel&&{position:"absolute",top:12,left:"calc(-50% + 20px)",right:"calc(50% + 20px)"})),mt=je("span",{name:"MuiStepConnector",slot:"Line",overridesResolver:(a,n)=>{const{ownerState:h}=a;return[n.line,n[`line${Do(h.orientation)}`]]}})(({ownerState:a,theme:n})=>{const h=n.palette.mode==="light"?n.palette.grey[400]:n.palette.grey[600];return B({display:"block",borderColor:n.vars?n.vars.palette.StepConnector.border:h},a.orientation==="horizontal"&&{borderTopStyle:"solid",borderTopWidth:1},a.orientation==="vertical"&&{borderLeftStyle:"solid",borderLeftWidth:1,minHeight:24})}),pt=i.forwardRef(function(n,h){const m=Ue({props:n,name:"MuiStepConnector"}),{className:x}=m,D=Ye(m,ct),{alternativeLabel:$,orientation:F="horizontal"}=i.useContext(Qe),{active:M,disabled:q,completed:b}=i.useContext(no),N=B({},m,{alternativeLabel:$,orientation:F,active:M,completed:b,disabled:q}),P=dt(N);return e.jsx(ut,B({className:Re(P.root,x),ref:h,ownerState:N},D,{children:e.jsx(mt,{className:P.line,ownerState:N})}))});function ft(a){return ze("MuiStepper",a)}qe("MuiStepper",["root","horizontal","vertical","nonLinear","alternativeLabel"]);const ht=["activeStep","alternativeLabel","children","className","component","connector","nonLinear","orientation"],gt=a=>{const{orientation:n,nonLinear:h,alternativeLabel:m,classes:x}=a;return He({root:["root",n,h&&"nonLinear",m&&"alternativeLabel"]},ft,x)},bt=je("div",{name:"MuiStepper",slot:"Root",overridesResolver:(a,n)=>{const{ownerState:h}=a;return[n.root,n[h.orientation],h.alternativeLabel&&n.alternativeLabel,h.nonLinear&&n.nonLinear]}})(({ownerState:a})=>B({display:"flex"},a.orientation==="horizontal"&&{flexDirection:"row",alignItems:"center"},a.orientation==="vertical"&&{flexDirection:"column"},a.alternativeLabel&&{alignItems:"flex-start"})),vt=e.jsx(pt,{}),xt=i.forwardRef(function(n,h){const m=Ue({props:n,name:"MuiStepper"}),{activeStep:x=0,alternativeLabel:D=!1,children:$,className:F,component:M="div",connector:q=vt,nonLinear:b=!1,orientation:N="horizontal"}=m,P=Ye(m,ht),re=B({},m,{nonLinear:b,alternativeLabel:D,orientation:N,component:M}),c=gt(re),W=i.Children.toArray($).filter(Boolean),pe=W.map((le,p)=>i.cloneElement(le,B({index:p,last:p+1===W.length},le.props))),de=i.useMemo(()=>({activeStep:x,alternativeLabel:D,connector:q,nonLinear:b,orientation:N}),[x,D,q,b,N]);return e.jsx(Qe.Provider,{value:de,children:e.jsx(bt,B({as:M,ownerState:re,className:Re(c.root,F),ref:h},P,{children:pe}))})}),Ve=Ze(e.jsx("path",{d:"M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4"}),"AttachMoney"),St=Ze(e.jsx("path",{d:"M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4m-9-2V7H4v3H1v2h3v3h2v-3h3v-2zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4"}),"PersonAdd"),jt=({open:a,onClose:n,onSubmit:h,isEditing:m,clientes:x,beneficiarios:D,matriculas:$,cursosDisponibles:F,setClientes:M,setBeneficiarios:q,initialData:b=null,ventasOriginales:N=[]})=>{const[P,re]=i.useState(!1),[c,W]=i.useState(0),[pe,de]=i.useState("slideLeft"),[le,p]=i.useState({show:!1,message:"",severity:"info"}),[y,ae]=i.useState(!1),[K,J]=i.useState(null),[ue,ce]=i.useState(!1),_e=y?["Datos de la Matrícula","Datos del Cliente","Datos del Beneficiario","Datos del Curso"]:["Datos de la Matrícula","Datos del Curso"],[s,ee]=i.useState({id:null,nombre:"",apellido:"",tipoDocumento:"",numeroDocumento:"",fechaNacimiento:"",age:"",direccion:"",telefono:"",estado:!0}),[r,k]=i.useState({id:null,nombre:"",apellido:"",tipoDocumento:"",numeroDocumento:"",fechaNacimiento:"",age:"",direccion:"",telefono:"",correo:"",estado:!0,password:"",confirmPassword:""}),[u,U]=i.useState({id:null,cliente:"",beneficiario:"",fechaInicio:"",fechaFin:"",matriculaId:"",valor:"0",descuento:"0",valorFinal:"0",observaciones:"",estado:"vigente"}),[X,Fe]=i.useState({id:null,curso:"",clases:"4",valorCurso:"",valorTotal:"",debe:"",estado:"debe",ciclo:""}),[Y,Ce]=i.useState({fechaPago:"",metodoPago:"Efectivo",valor_total:"0",numeroTransaccion:""}),[so,Ke]=i.useState(""),[lo,eo]=i.useState(""),[co,oo]=i.useState([]),[uo,Ge]=i.useState([]),[mo,po]=i.useState(!1),[fo,ho]=i.useState(!1),[f,I]=i.useState(!1),[_,H]=i.useState(!1),[Me,V]=i.useState(!1),[ve,we]=i.useState(!1),[Pe,De]=i.useState(!1),[S,j]=i.useState(!1),Z=[{value:"CC",label:"Cédula de Ciudadanía (CC)"},{value:"TI",label:"Tarjeta de Identidad (TI)"},{value:"CE",label:"Cédula de Extranjería (CE)"},{value:"PA",label:"Pasaporte (PA)"},{value:"RC",label:"Registro Civil (RC)"},{value:"NIT",label:"NIT"}],T=t=>(t??"").toString().replace(/\D/g,"").slice(0,10),R=t=>(t??"").toString().length===10,me=t=>/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test((t??"").toString()),L=t=>{if(!t)return!0;const d=new Date(t),v=new Date().getFullYear();return d.getFullYear()<v},oe=t=>({length:(t??"").length>=8,upper:/[A-Z]/.test(t??""),lower:/[a-z]/.test(t??""),number:/[0-9]/.test(t??"")}),te=t=>{const d=new Date;return(N||[]).some(v=>{const o=(v==null?void 0:v._original)||v,l=String((o==null?void 0:o.tipo)||"").toLowerCase(),C=String((o==null?void 0:o.estado)||"").toLowerCase(),z=o!=null&&o.fechaFin?new Date(o.fechaFin):null,ie=z?z>=d:!0,se=o==null?void 0:o.beneficiarioId,Ie=String(se&&typeof se=="object"?se._id:se);return l==="matricula"&&C==="vigente"&&ie&&Ie===String(t)})},Le=()=>D.filter(t=>String(t.clienteId||"").toLowerCase().includes("cliente")?!1:!te(t._id)),fe=t=>t?t.charAt(0).toUpperCase()+t.slice(1).toLowerCase():"",ye=t=>{if(!t)return"";if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;try{return new Date(t).toISOString().split("T")[0]}catch{return""}},xe=t=>{if(!t)return"";const d=new Date,v=new Date(t);let o=d.getFullYear()-v.getFullYear();const l=d.getMonth()-v.getMonth();return(l<0||l===0&&d.getDate()<v.getDate())&&o--,o},$e=t=>{if(!t){J(null);return}J(t),k({id:t._id,nombre:t.nombre||"",apellido:t.apellido||"",tipoDocumento:t.tipo_de_documento||"TI",numeroDocumento:t.numero_de_documento||"",fechaNacimiento:ye(t.fechaDeNacimiento),age:xe(t.fechaDeNacimiento),direccion:t.direccion||"",telefono:t.telefono||"",correo:t.correo||"",estado:t.estado!==void 0?t.estado:!0,password:"",confirmPassword:""});const d=String(t.clienteId||""),v=String(t._id);if(d===v)re(!0),ee({id:t._id,nombre:t.nombre||"",apellido:t.apellido||"",tipoDocumento:t.tipo_de_documento||"CC",numeroDocumento:t.numero_de_documento||"",fechaNacimiento:ye(t.fechaDeNacimiento),age:xe(t.fechaDeNacimiento),direccion:t.direccion||"",telefono:t.telefono||"",estado:t.estado!==void 0?t.estado:!0});else{re(!1);const l=D.find(C=>String(C._id)===d);l&&ee({id:l._id,nombre:l.nombre||"",apellido:l.apellido||"",tipoDocumento:l.tipo_de_documento||"",numeroDocumento:l.numero_de_documento||"",fechaNacimiento:ye(l.fechaDeNacimiento),age:xe(l.fechaDeNacimiento),direccion:l.direccion||"",telefono:l.telefono||"",estado:l.estado!==void 0?l.estado:!0})}const o=D.find(l=>String(l._id)===d);U(l=>({...l,cliente:P?`${t.nombre} ${t.apellido}`:o?`${o.nombre} ${o.apellido}`:`${t.nombre} ${t.apellido}`,beneficiario:`${t.nombre} ${t.apellido}`}))};i.useEffect(()=>{P&&y&&s.nombre&&k(t=>({...s,id:null,tipoDocumento:s.tipoDocumento||"TI",correo:t.correo||"",password:t.password||"",confirmPassword:t.confirmPassword||""}))},[P,s,y]),i.useEffect(()=>{if(a)if(console.log("Modal abierto, isEditing:",m,"initialData:",b),Ae(),m&&b){if(console.log("Cargando datos para edición:",b),!b||!b.beneficiarioObj&&!b._original){console.warn("No se encontraron datos del beneficiario para editar");return}let t=b.beneficiarioObj;if(!t&&b._original&&(t=D.find(d=>String(d._id)===String(b._original.beneficiarioId)),console.log("Beneficiario encontrado por ID:",t)),t){if(W(1),$e(t),b&&b._original){const d=b._original,v={id:d._id,cliente:b.cliente||"",beneficiario:b.beneficiario||"",fechaInicio:ye(d.fechaInicio),fechaFin:ye(d.fechaFin),matriculaId:d.matriculaId||"",valor:String(d.valor_total||0),descuento:String(d.descuento||0),valorFinal:String((d.valor_total||0)-(d.descuento||0)),observaciones:d.observaciones||"",estado:d.estado||"vigente"};console.log("Datos de la matrícula a cargar:",v),U(v)}}else console.error("No se pudo encontrar el beneficiario para editar");console.log("Datos cargados completamente para edición")}else console.log("Modo creación - formulario reiniciado")},[a,m,b,D]);const Ae=()=>{ee({id:null,nombre:"",apellido:"",tipoDocumento:"",numeroDocumento:"",fechaNacimiento:"",age:"",direccion:"",telefono:"",estado:!0}),k({id:null,nombre:"",apellido:"",tipoDocumento:"",numeroDocumento:"",fechaNacimiento:"",age:"",direccion:"",telefono:"",correo:"",estado:!0,password:"",confirmPassword:""}),U({id:null,cliente:"",beneficiario:"",fechaInicio:"",fechaFin:"",matriculaId:"",valor:"0",descuento:"0",valorFinal:"0",observaciones:"",estado:"vigente"}),Fe({id:null,curso:"",clases:"4",valorCurso:"",valorTotal:"",debe:"",estado:"debe"}),Ce({fechaPago:"",metodoPago:"Efectivo",valor_total:"0",numeroTransaccion:""}),Ke(""),eo(""),oo([]),Ge([]),I(!1),H(!1),V(!1),we(!1),De(!1),j(!1),p({show:!1,message:"",severity:"info"}),W(0),re(!1),ae(!1),J(null)},Q=()=>{let t=!0;if(y)switch(c){case 0:(!u.fechaInicio||!u.fechaFin||!u.matriculaId)&&(p({show:!0,message:"Por favor complete todos los campos obligatorios de la matrícula",severity:"error"}),t=!1);break;case 1:if((!s.nombre||!s.tipoDocumento||!s.numeroDocumento)&&(p({show:!0,message:"Por favor complete todos los campos obligatorios del cliente",severity:"error"}),t=!1),t){const d=T(s.numeroDocumento),v=T(s.telefono);R(d)?v&&!R(v)?(p({show:!0,message:"El teléfono del cliente debe tener exactamente 10 dígitos",severity:"error"}),t=!1):L(s.fechaNacimiento)||(p({show:!0,message:"La fecha de nacimiento del cliente no puede ser del año actual o futuro",severity:"error"}),t=!1):(p({show:!0,message:"El N° de documento del cliente debe tener exactamente 10 dígitos",severity:"error"}),t=!1)}break;case 2:if((!r.nombre||!r.tipoDocumento||!r.numeroDocumento)&&(p({show:!0,message:"Por favor complete todos los campos obligatorios del beneficiario",severity:"error"}),t=!1),!m&&!r.correo&&(p({show:!0,message:"Por favor ingrese un correo electrónico para el beneficiario",severity:"error"}),t=!1),!m&&!r.password&&(p({show:!0,message:"Por favor ingrese una contraseña para el beneficiario",severity:"error"}),t=!1),!m&&r.password!==r.confirmPassword&&(p({show:!0,message:"Las contraseñas no coinciden",severity:"error"}),t=!1),t){const d=T(r.numeroDocumento),v=T(r.telefono);if(!R(d))p({show:!0,message:"El N° de documento del beneficiario debe tener exactamente 10 dígitos",severity:"error"}),t=!1;else if(v&&!R(v))p({show:!0,message:"El teléfono del beneficiario debe tener exactamente 10 dígitos",severity:"error"}),t=!1;else if(!L(r.fechaNacimiento))p({show:!0,message:"La fecha de nacimiento del beneficiario no puede ser del año actual o futuro",severity:"error"}),t=!1;else if(!m&&!me(r.correo))p({show:!0,message:"Debe ingresar un correo electrónico válido",severity:"error"}),t=!1;else if(!m){const o=oe(r.password);(!o.length||!o.upper||!o.lower||!o.number)&&(p({show:!0,message:"La contraseña debe tener mínimo 8 caracteres e incluir mayúscula, minúscula y número",severity:"error"}),t=!1)}}break}else switch(c){case 0:K||(p({show:!0,message:"Por favor seleccione un beneficiario",severity:"error"}),t=!1),(!u.fechaInicio||!u.fechaFin||!u.matriculaId)&&(p({show:!0,message:"Por favor complete todos los campos obligatorios de la matrícula",severity:"error"}),t=!1);break}t&&(W(d=>d+1),de("slideLeft"),p({show:!1,message:"",severity:"info"})),t&&(y&&c===1||!y&&c===0)&&U(d=>({...d,cliente:`${s.nombre} ${s.apellido}`,beneficiario:`${r.nombre} ${r.apellido}`}))},ne=()=>{de("slideRight"),W(t=>t-1)},E=F.filter(t=>t.estado);i.useEffect(()=>{if(u.valor){const t=Number.parseFloat(u.valor),d=Number.parseFloat(u.descuento||0),v=t-d;U(o=>({...o,valorFinal:v>=0?v.toString():"0"})),Ce(o=>({...o,valor_total:v>=0?v.toString():"0"}))}},[u.valor,u.descuento]),i.useEffect(()=>{if(s.fechaNacimiento&&s.fechaNacimiento.trim()!==""){const t=xe(s.fechaNacimiento);ee(d=>({...d,age:t}))}},[s.fechaNacimiento]),i.useEffect(()=>{if(r.fechaNacimiento&&r.fechaNacimiento.trim()!==""){const t=xe(r.fechaNacimiento);k(d=>({...d,age:t}))}},[r.fechaNacimiento]),i.useEffect(()=>{y&&W(0)},[y]),i.useEffect(()=>{if(c===0&&!u.fechaInicio&&!m){const t=new Date,d=t.toISOString().split("T")[0],v=new Date(t.setFullYear(t.getFullYear()+1)).toISOString().split("T")[0];U(o=>({...o,fechaInicio:d,fechaFin:v})),Ce(o=>({...o,fechaPago:new Date().toISOString().split("T")[0]}))}},[c,m,u.fechaInicio]);const G=()=>{if(ue){console.log("Formulario ya está siendo enviado, ignorando...");return}const t=Math.random().toString(36).substr(2,9);console.log(`=== INICIANDO VALIDACIÓN DEL FORMULARIO [${t}] ===`),console.log("Timestamp:",new Date().toISOString()),console.log("ClienteData:",s),console.log("BeneficiarioData:",r),console.log("MatriculaData:",u),console.log("PagoData:",Y),console.log("ShowCreateForm:",y),console.log("IsEditing:",m),ce(!0),console.log(`[${t}] isSubmitting set to:`,!0);try{if(!u.fechaInicio||!u.fechaFin||!u.matriculaId){p({show:!0,message:"Por favor complete todos los campos obligatorios de la matrícula (fechas y tipo de matrícula)",severity:"error"});return}if(!Y.fechaPago||!Y.metodoPago){p({show:!0,message:"Por favor complete todos los campos obligatorios del pago (fecha y método de pago)",severity:"error"});return}if(y){if(!s.nombre||!s.apellido||!s.tipoDocumento||!s.numeroDocumento){p({show:!0,message:"Por favor complete todos los campos obligatorios del cliente (nombre, apellido, tipo y número de documento)",severity:"error"});return}const se=T(s.numeroDocumento),Ie=T(s.telefono);if(!R(se)){p({show:!0,message:"El N° de documento del cliente debe tener exactamente 10 dígitos",severity:"error"});return}if(Ie&&!R(Ie)){p({show:!0,message:"El teléfono del cliente debe tener exactamente 10 dígitos",severity:"error"});return}if(!L(s.fechaNacimiento)){p({show:!0,message:"La fecha de nacimiento del cliente no puede ser del año actual o futuro",severity:"error"});return}if(!r.nombre||!r.apellido||!r.tipoDocumento||!r.numeroDocumento){p({show:!0,message:"Por favor complete todos los campos obligatorios del beneficiario (nombre, apellido, tipo y número de documento)",severity:"error"});return}const yo=T(r.numeroDocumento),go=T(r.telefono);if(!R(yo)){p({show:!0,message:"El N° de documento del beneficiario debe tener exactamente 10 dígitos",severity:"error"});return}if(go&&!R(go)){p({show:!0,message:"El teléfono del beneficiario debe tener exactamente 10 dígitos",severity:"error"});return}if(!L(r.fechaNacimiento)){p({show:!0,message:"La fecha de nacimiento del beneficiario no puede ser del año actual o futuro",severity:"error"});return}if(!m){if(!r.correo||!me(r.correo)){p({show:!0,message:"Por favor ingrese un correo electrónico válido para el beneficiario",severity:"error"});return}const Je=oe(r.password);if(!r.password||!Je.length||!Je.upper||!Je.lower||!Je.number){p({show:!0,message:"La contraseña debe tener mínimo 8 caracteres e incluir mayúscula, minúscula y número",severity:"error"});return}if(r.password!==r.confirmPassword){p({show:!0,message:"Las contraseñas no coinciden",severity:"error"});return}}}else if(!K){p({show:!0,message:"Por favor seleccione un beneficiario existente",severity:"error"});return}const d=((K==null?void 0:K._id)||r.id||"").toString();if(d&&te(d)){p({show:!0,message:"El beneficiario ya tiene una matrícula vigente. No es posible crear otra.",severity:"warning"});return}console.log(`[${t}] === VALIDACIÓN EXITOSA - PROCEDIENDO CON EL ENVÍO ===`);const v={nombre:r.nombre,apellido:r.apellido,email:r.correo,contrasena:r.password,documento:r.numeroDocumento,estado:!0},o={id:r.id,nombre:r.nombre,apellido:r.apellido,tipoDocumento:r.tipoDocumento,numeroDocumento:r.numeroDocumento,telefono:r.telefono,direccion:r.direccion,fechaNacimiento:r.fechaNacimiento,correo:r.correo,estado:!0,clienteId:P?null:"cliente"},l=P?null:{id:s.id,nombre:s.nombre,apellido:s.apellido,tipoDocumento:s.tipoDocumento,numeroDocumento:s.numeroDocumento,telefono:s.telefono,direccion:s.direccion,fechaNacimiento:s.fechaNacimiento,estado:!0,clienteId:"cliente"},C={id:u.id,cliente:y?`${s.nombre} ${s.apellido}`:u.cliente,beneficiario:y?`${r.nombre} ${r.apellido}`:u.beneficiario,fechaInicio:u.fechaInicio,fechaFin:u.fechaFin,matriculaId:u.matriculaId,valor:Number.parseFloat(u.valor),descuento:Number.parseFloat(u.descuento||0),valorFinal:Number.parseFloat(u.valorFinal),observaciones:u.observaciones,estado:u.estado},z=!m&&X.curso?{curso:X.curso,clases:Number.parseInt(X.clases),ciclo:X.ciclo||null,valorCurso:Number.parseFloat(X.valorCurso||0),valorTotal:Number.parseFloat(X.valorTotal||0)}:null,ie={fechaPago:Y.fechaPago,metodoPago:Y.metodoPago,valor_total:Number.parseFloat(Y.valor_total||u.valorFinal),numeroTransaccion:Y.numeroTransaccion};h({matricula:C,beneficiario:o,usuarioBeneficiario:v,cliente:l,clienteEsBeneficiario:P,curso:z,pago:ie,isEditing:m}),console.log(`[${t}] onSubmit del padre llamado exitosamente`)}catch(d){console.error(`[${t}] Error en validación del formulario:`,d)}finally{ce(!1),console.log(`[${t}] isSubmitting reset to:`,!1)}},Se=()=>{var v;const t=pe==="slideLeft"?"slide-left":"slide-right";let d="";if(y)switch(c){case 0:d="matricula";break;case 1:d="cliente";break;case 2:d="beneficiario";break;case 3:d="curso";break}else switch(c){case 0:d="matricula";break;case 1:d="curso";break}switch(d){case"matricula":return e.jsxs(be,{className:t,sx:{animation:`${t} 0.3s forwards`},children:[e.jsx(he,{variant:"h6",sx:{mb:2,color:"#0455a2",fontWeight:500},children:"Datos de la Matrícula"}),!m&&!y&&e.jsxs(xo,{elevation:0,sx:{p:2,mb:3,border:"1px solid #e0e0e0",borderRadius:"8px"},children:[e.jsx(he,{variant:"subtitle1",sx:{mb:2,color:"#0455a2",fontWeight:500},children:"Seleccionar Beneficiario"}),e.jsx(Vo,{options:Le(),getOptionLabel:o=>`${o.nombre} ${o.apellido} - ${o.numero_de_documento}`,value:K,onChange:(o,l)=>{if($e(l),l){const C=String(l.clienteId||""),z=String(l._id),ie=C===z,se=D.find(Ie=>String(Ie._id)===C);setTimeout(()=>{U(Ie=>({...Ie,cliente:ie?`${l.nombre} ${l.apellido}`:se?`${se.nombre} ${se.apellido}`:`${l.nombre} ${l.apellido}`,beneficiario:`${l.nombre} ${l.apellido}`}))},100)}else U(C=>({...C,cliente:"",beneficiario:""}))},renderInput:o=>e.jsx(w,{...o,label:"Buscar beneficiario",placeholder:"Seleccione un beneficiario existente",InputProps:{...o.InputProps,startAdornment:e.jsx(Te,{position:"start",children:e.jsx(zo,{})})}}),renderOption:(o,l)=>e.jsxs(be,{component:"li",...o,children:[e.jsx(Ro,{sx:{bgcolor:"#0455a2",mr:2},children:e.jsx(bo,{})}),e.jsxs(be,{children:[e.jsxs(he,{variant:"body1",children:[l.nombre," ",l.apellido]}),e.jsxs(he,{variant:"body2",color:"text.secondary",children:[l.tipo_de_documento,": ",l.numero_de_documento]})]})]}),noOptionsText:"No hay beneficiarios disponibles",sx:{mb:2}}),e.jsx(be,{sx:{display:"flex",justifyContent:"center"},children:e.jsx(Xe,{variant:"outlined",startIcon:e.jsx(St,{}),onClick:()=>{J(null);const o={id:null,nombre:"",apellido:"",tipoDocumento:"",numeroDocumento:"",fechaNacimiento:"",age:"",direccion:"",telefono:"",correo:"",estado:!0,password:"",confirmPassword:""},l={id:null,nombre:"",apellido:"",tipoDocumento:"",numeroDocumento:"",fechaNacimiento:"",age:"",direccion:"",telefono:"",estado:!0};k(o),ee(l),re(!1),ae(!0);const C=new Date,z=C.toISOString().split("T")[0],ie=new Date(C.setFullYear(C.getFullYear()+1)).toISOString().split("T")[0];U(se=>({...se,fechaInicio:z,fechaFin:ie,cliente:"Por crear",beneficiario:"Por crear"})),Ce(se=>({...se,fechaPago:new Date().toISOString().split("T")[0]}))},sx:{textTransform:"none",borderColor:"#0455a2",color:"#0455a2","&:hover":{borderColor:"#033b70",bgcolor:"rgba(4, 85, 162, 0.04)"}},children:"Crear nuevo cliente y beneficiario"})}),y&&e.jsx(vo,{severity:"info",sx:{mt:2},children:"Se habilitarán los formularios para crear cliente y beneficiario."})]}),e.jsx(xo,{elevation:0,sx:{p:2,mb:3,border:"1px solid #e0e0e0",borderRadius:"8px"},children:e.jsxs(g,{container:!0,spacing:2,children:[e.jsxs(g,{item:!0,xs:12,sm:6,children:[e.jsx(he,{variant:"subtitle2",sx:{color:"#0455a2"},children:"Cliente"}),e.jsx(he,{children:y?"Por crear":u.cliente||"Por seleccionar"})]}),e.jsxs(g,{item:!0,xs:12,sm:6,children:[e.jsx(he,{variant:"subtitle2",sx:{color:"#0455a2"},children:"Beneficiario"}),e.jsx(he,{children:y?"Por crear":u.beneficiario||"Por seleccionar"})]})]})}),e.jsxs(g,{container:!0,spacing:2,children:[e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,required:!0,label:"Fecha de Inicio",type:"date",value:u.fechaInicio,onChange:o=>U({...u,fechaInicio:o.target.value}),margin:"normal",InputLabelProps:{shrink:!0}})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,required:!0,label:"Fecha de Fin",type:"date",value:u.fechaFin,onChange:o=>U({...u,fechaFin:o.target.value}),margin:"normal",InputLabelProps:{shrink:!0}})}),e.jsx(g,{item:!0,xs:12,children:e.jsx(So,{sx:{my:2},children:"Selección de Matrícula"})}),e.jsx(g,{item:!0,xs:12,children:e.jsxs(Oe,{fullWidth:!0,margin:"normal",required:!0,children:[e.jsx(Be,{children:"Tipo de Matrícula"}),e.jsx(We,{value:u.matriculaId||"",onChange:o=>{const l=$.find(C=>C._id===o.target.value);if(l){const C=l.valorMatricula,z=Number.parseFloat(u.descuento||0),ie=C-z;U({...u,matriculaId:o.target.value,valor:C.toString(),valorFinal:ie>=0?ie.toString():"0"})}},label:"Tipo de Matrícula",children:$.filter(o=>o.estado).map(o=>{var l;return e.jsxs(ge,{value:o._id,children:[o.nombre," - $",((l=o.valorMatricula)==null?void 0:l.toLocaleString())||0]},o._id)})})]})}),e.jsx(g,{item:!0,xs:12,children:e.jsx(w,{fullWidth:!0,label:"Observaciones",value:u.observaciones,onChange:o=>U({...u,observaciones:o.target.value}),margin:"normal",multiline:!0,minRows:2})}),e.jsx(g,{item:!0,xs:12,children:e.jsx(So,{sx:{my:2},children:"Información de Pago"})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,label:"Valor Base de la Matrícula",type:"number",value:u.valor,margin:"normal",InputProps:{readOnly:!0,startAdornment:e.jsx(Te,{position:"start",children:e.jsx(Ve,{})})},disabled:!0})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,label:"Monto de Descuento",type:"number",value:u.descuento,onChange:o=>{const l=Number.parseFloat(o.target.value||0),z=Number.parseFloat(u.valor||0)-l;U({...u,descuento:o.target.value,valorFinal:z>=0?z.toString():"0"})},margin:"normal",InputProps:{startAdornment:e.jsx(Te,{position:"start",children:e.jsx(Ve,{})}),inputProps:{min:0,max:u.valor}}})}),e.jsx(g,{item:!0,xs:12,children:e.jsx(w,{fullWidth:!0,label:"Total a Pagar",type:"number",value:u.valorFinal,margin:"normal",InputProps:{readOnly:!0,startAdornment:e.jsx(Te,{position:"start",children:e.jsx(Ve,{})})},sx:{"& .MuiInputBase-input":{fontWeight:600,fontSize:"1.1rem"}}})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,required:!0,label:"Fecha de Pago",type:"date",value:Y.fechaPago,onChange:o=>Ce({...Y,fechaPago:o.target.value}),margin:"normal",InputLabelProps:{shrink:!0}})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsxs(Oe,{fullWidth:!0,margin:"normal",required:!0,children:[e.jsx(Be,{children:"Método de Pago"}),e.jsxs(We,{value:Y.metodoPago,onChange:o=>Ce({...Y,metodoPago:o.target.value}),label:"Método de Pago",children:[e.jsx(ge,{value:"Tarjeta",children:"Tarjeta"}),e.jsx(ge,{value:"Transferencia",children:"Transferencia"}),e.jsx(ge,{value:"Efectivo",children:"Efectivo"}),e.jsx(ge,{value:"PSE",children:"PSE"}),e.jsx(ge,{value:"Nequi",children:"Nequi"}),e.jsx(ge,{value:"Daviplata",children:"Daviplata"})]})]})}),e.jsx(g,{item:!0,xs:12,children:e.jsx(w,{fullWidth:!0,label:"Número de Transacción",value:Y.numeroTransaccion,onChange:o=>Ce({...Y,numeroTransaccion:o.target.value}),margin:"normal",placeholder:"Número de transacción (opcional)"})})]})]});case"cliente":return e.jsxs(be,{className:t,sx:{animation:`${t} 0.3s forwards`},children:[e.jsx(he,{variant:"h6",sx:{mb:2,color:"#0455a2",fontWeight:500},children:"Datos del Cliente"}),e.jsxs(g,{container:!0,spacing:2,children:[e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,required:!0,label:"Nombre",value:s.nombre,onChange:o=>ee({...s,nombre:fe(o.target.value)}),margin:"normal"})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,required:!0,label:"Apellido",value:s.apellido,onChange:o=>ee({...s,apellido:fe(o.target.value)}),margin:"normal"})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsxs(Oe,{fullWidth:!0,margin:"normal",children:[e.jsx(Be,{children:"Tipo Documento"}),e.jsx(We,{value:s.tipoDocumento,onChange:o=>ee({...s,tipoDocumento:o.target.value}),label:"Tipo Documento",children:Z.map(o=>e.jsx(ge,{value:o.value,children:o.label},o.value))})]})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,required:!0,label:"Número de Documento",value:s.numeroDocumento,onChange:o=>ee({...s,numeroDocumento:T(o.target.value)}),margin:"normal",error:!!s.numeroDocumento&&!R(s.numeroDocumento),helperText:s.numeroDocumento&&!R(s.numeroDocumento)?"Debe contener exactamente 10 dígitos":"",inputProps:{maxLength:10,inputMode:"numeric"}})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,type:"date",label:"Fecha de Nacimiento",value:s.fechaNacimiento,onChange:o=>ee({...s,fechaNacimiento:o.target.value}),margin:"normal",InputLabelProps:{shrink:!0}})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,label:"Edad",value:s.age,InputProps:{readOnly:!0},margin:"normal"})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,label:"Dirección",value:s.direccion,onChange:o=>ee({...s,direccion:o.target.value}),margin:"normal"})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,label:"Teléfono",value:s.telefono,onChange:o=>ee({...s,telefono:T(o.target.value)}),margin:"normal",error:!!s.telefono&&!R(s.telefono),helperText:s.telefono&&!R(s.telefono)?"Debe contener exactamente 10 dígitos":"",inputProps:{maxLength:10,inputMode:"numeric"}})}),!m&&e.jsx(g,{item:!0,xs:12,sx:{mt:2},children:e.jsx(Wo,{control:e.jsx(ko,{checked:P,onChange:o=>{const l=o.target.checked;re(l),l&&(k(C=>({...s,id:null,tipoDocumento:s.tipoDocumento||"TI",correo:C.correo||"",password:C.password||"",confirmPassword:C.confirmPassword||""})),Q())},sx:{color:"#0455a2","&.Mui-checked":{color:"#0455a2"}}}),label:"Cliente es beneficiario",sx:{"& .MuiFormControlLabel-label":{fontWeight:500,color:"#0455a2"}}})})]})]});case"beneficiario":return e.jsxs(be,{className:t,sx:{animation:`${t} 0.3s forwards`},children:[e.jsx(he,{variant:"h6",sx:{mb:2,color:"#0455a2",fontWeight:500},children:"Datos del Beneficiario"}),e.jsxs(g,{container:!0,spacing:2,children:[e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,required:!0,label:"Nombre",value:r.nombre,onChange:o=>k({...r,nombre:fe(o.target.value)}),margin:"normal"})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,required:!0,label:"Apellido",value:r.apellido,onChange:o=>k({...r,apellido:fe(o.target.value)}),margin:"normal"})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsxs(Oe,{fullWidth:!0,margin:"normal",children:[e.jsx(Be,{children:"Tipo Documento"}),e.jsx(We,{value:r.tipoDocumento,onChange:o=>k({...r,tipoDocumento:o.target.value}),label:"Tipo Documento",children:Z.map(o=>e.jsx(ge,{value:o.value,children:o.label},o.value))})]})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,required:!0,label:"Número de Documento",value:r.numeroDocumento,onChange:o=>k({...r,numeroDocumento:T(o.target.value)}),margin:"normal",error:!!r.numeroDocumento&&!R(r.numeroDocumento),helperText:r.numeroDocumento&&!R(r.numeroDocumento)?"Debe contener exactamente 10 dígitos":"",inputProps:{maxLength:10,inputMode:"numeric"}})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,type:"date",label:"Fecha de Nacimiento",value:r.fechaNacimiento,onChange:o=>k({...r,fechaNacimiento:o.target.value}),margin:"normal",InputLabelProps:{shrink:!0}})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,label:"Edad",value:r.age,InputProps:{readOnly:!0},margin:"normal"})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,label:"Dirección",value:r.direccion,onChange:o=>k({...r,direccion:o.target.value}),margin:"normal"})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,label:"Teléfono",value:r.telefono,onChange:o=>k({...r,telefono:T(o.target.value)}),margin:"normal",error:!!r.telefono&&!R(r.telefono),helperText:r.telefono&&!R(r.telefono)?"Debe contener exactamente 10 dígitos":"",inputProps:{maxLength:10,inputMode:"numeric"}})}),e.jsx(g,{item:!0,xs:12,children:e.jsx(w,{fullWidth:!0,required:!m,label:"Correo Electrónico",type:"email",value:r.correo,onChange:o=>k({...r,correo:o.target.value}),margin:"normal",error:!!r.correo&&!me(r.correo),helperText:r.correo&&!me(r.correo)?"Debe ser un correo electrónico válido":""})}),!m&&e.jsxs(e.Fragment,{children:[e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,required:!0,type:"password",label:"Contraseña",value:r.password,onChange:o=>k({...r,password:o.target.value}),margin:"normal",error:!!r.password&&!Object.values(oe(r.password)).every(Boolean),helperText:r.password?e.jsx("span",{children:e.jsxs("ul",{style:{margin:0,paddingLeft:16},children:[e.jsxs("li",{style:{color:oe(r.password).length?"green":void 0},children:[oe(r.password).length?"✓":"•"," Mínimo 8 caracteres"]}),e.jsxs("li",{style:{color:oe(r.password).upper?"green":void 0},children:[oe(r.password).upper?"✓":"•"," Al menos una mayúscula"]}),e.jsxs("li",{style:{color:oe(r.password).lower?"green":void 0},children:[oe(r.password).lower?"✓":"•"," Al menos una minúscula"]}),e.jsxs("li",{style:{color:oe(r.password).number?"green":void 0},children:[oe(r.password).number?"✓":"•"," Al menos un número"]})]})}):""})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,required:!0,type:"password",label:"Confirmar Contraseña",value:r.confirmPassword,onChange:o=>k({...r,confirmPassword:o.target.value}),margin:"normal",error:!!r.confirmPassword&&r.password!==r.confirmPassword,helperText:r.confirmPassword?r.password===r.confirmPassword?e.jsx("span",{style:{color:"green"},children:"✓ Las contraseñas coinciden"}):"Las contraseñas no coinciden":""})})]})]})]});case"curso":return m?null:e.jsxs(be,{className:t,sx:{animation:`${t} 0.3s forwards`},children:[e.jsx(he,{variant:"h6",sx:{mb:2,color:"#0455a2",fontWeight:500},children:"Información del Curso (Opcional)"}),e.jsxs(g,{container:!0,spacing:2,children:[e.jsx(g,{item:!0,xs:12,children:e.jsxs(Oe,{fullWidth:!0,margin:"normal",children:[e.jsx(Be,{id:"curso-label",children:"Curso"}),e.jsxs(We,{labelId:"curso-label",value:X.curso,label:"Curso",onChange:o=>{const l=E.find(C=>C.nombre===o.target.value);Fe(C=>({...C,curso:o.target.value,clases:"4",valorCurso:l?l.valor_por_hora:"",valorTotal:l?Number(l.valor_por_hora)*4:""}))},children:[e.jsx(ge,{value:"",children:"Sin curso"}),E.map(o=>e.jsx(ge,{value:o.nombre,children:o.nombre},o._id))]})]})}),X.curso&&e.jsxs(e.Fragment,{children:[e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,label:"Número de Clases",type:"number",value:X.clases,margin:"normal",InputProps:{inputProps:{min:1}},onChange:o=>{const l=E.find(ie=>ie.nombre===X.curso),C=l?l.valor_por_hora:0,z=Number(o.target.value);Fe(ie=>({...ie,clases:o.target.value,valorTotal:C*z}))}})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,label:"Ciclo",value:X.ciclo,onChange:o=>Fe(l=>({...l,ciclo:o.target.value})),margin:"normal",placeholder:"Ej: 2025-1"})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,label:"Valor por Hora",type:"number",value:((v=E.find(o=>o.nombre===X.curso))==null?void 0:v.valor_por_hora)||"",margin:"normal",InputProps:{readOnly:!0,startAdornment:e.jsx(Te,{position:"start",children:e.jsx(Ve,{})})}})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(w,{fullWidth:!0,label:"Valor Total del Curso",type:"number",value:X.valorTotal,margin:"normal",InputProps:{readOnly:!0,startAdornment:e.jsx(Te,{position:"start",children:e.jsx(Ve,{})})}})})]})]})]});default:return null}};return e.jsxs(No,{open:a,onClose:n,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{borderRadius:"12px",maxHeight:"90vh"}},children:[e.jsxs(_o,{sx:{bgcolor:"#0455a2",color:"white",display:"flex",justifyContent:"space-between",alignItems:"center",p:2},children:[m?"Editar Matrícula":"Nueva Matrícula",e.jsx(Po,{onClick:n,sx:{color:"white"},children:e.jsx(Lo,{})})]}),e.jsxs(Fo,{sx:{pt:3,pb:1,mt:2,display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(xt,{activeStep:c,alternativeLabel:!0,sx:{mb:4},children:[e.jsx(ke,{children:e.jsx(Ee,{icon:e.jsx(to,{color:c>=0?"primary":"disabled"}),StepIconProps:{completed:c>0,active:c===0},children:"Matrícula"})}),y&&e.jsxs(e.Fragment,{children:[e.jsx(ke,{children:e.jsx(Ee,{icon:e.jsx(Mo,{color:c>=1?"primary":"disabled"}),StepIconProps:{completed:c>1,active:c===1},children:"Cliente"})}),e.jsx(ke,{children:e.jsx(Ee,{icon:e.jsx(bo,{color:c>=2?"primary":"disabled"}),StepIconProps:{completed:c>2,active:c===2},children:"Beneficiario"})}),e.jsx(ke,{children:e.jsx(Ee,{icon:e.jsx(to,{color:c>=3?"primary":"disabled"}),StepIconProps:{completed:c>3,active:c===3},children:"Curso"})})]}),!y&&!m&&e.jsx(ke,{children:e.jsx(Ee,{icon:e.jsx(to,{color:c>=1?"primary":"disabled"}),StepIconProps:{completed:c>1,active:c===1},children:"Curso"})})]}),le.show&&e.jsx(vo,{severity:le.severity,sx:{mb:2},onClose:()=>p({show:!1,message:"",severity:"info"}),children:le.message}),e.jsx(be,{sx:{flexGrow:1,overflow:"auto"},children:Se()})]}),e.jsx($o,{sx:{p:2,bgcolor:"#f8f9fa",borderTop:"1px solid #e9ecef",display:"flex",justifyContent:"space-between",alignItems:"center"},children:e.jsxs(be,{sx:{display:"flex",gap:2,ml:"auto"},children:[e.jsx(Xe,{onClick:n,variant:"outlined",sx:{textTransform:"none",borderColor:"rgba(0, 0, 0, 0.12)",color:"text.secondary","&:hover":{borderColor:"rgba(0, 0, 0, 0.24)"}},children:"Cancelar"}),c>0&&e.jsx(Xe,{onClick:ne,variant:"outlined",sx:{textTransform:"none",borderColor:"#0455a2",color:"#0455a2","&:hover":{borderColor:"#033b70"}},children:"Anterior"}),e.jsxs(be,{sx:{position:"relative",display:"inline-flex"},children:[e.jsx(Xe,{onClick:c===_e.length-1?G:Q,variant:"contained",disabled:ue,sx:{textTransform:"none",bgcolor:"#0455a2","&:hover":{bgcolor:"#033b70"}},children:c===_e.length-1?"Guardar":"Siguiente"}),c===_e.length-1&&ue&&e.jsx(To,{size:24,sx:{color:Eo[500],position:"absolute",top:"50%",left:"50%",marginTop:"-12px",marginLeft:"-12px"}})]})]})}),e.jsx("style",{jsx:!0,global:!0,children:`
        @keyframes slide-left {
          from {
            opacity: 0;
            transform: translateX(50px);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }
        
        @keyframes slide-right {
          from {
            opacity: 0;
            transform: translateX(-50px);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }
      `})]})},O="http://localhost:3000/api",Rt=()=>{const{showSuccess:a,showError:n}=Ao(),[h,m]=i.useState([]),[x,D]=i.useState([]),[$,F]=i.useState([]),[M,q]=i.useState([]),[b,N]=i.useState([]),[P,re]=i.useState([]),[c,W]=i.useState(null),[pe,de]=i.useState(!1),[le,p]=i.useState(!1),[y,ae]=i.useState(!1),[K,J]=i.useState(!1),[ue,ce]=i.useState(!1),[io,_e]=i.useState(!1),[s,ee]=i.useState(null),[r,k]=i.useState(null),[u,U]=i.useState("");i.useEffect(()=>{(async()=>{await X(),await Fe(),await Ce()})()},[]),i.useEffect(()=>{m(x)},[x]);const X=async()=>{try{const I=(await A.get(`${O}/beneficiarios`)).data;q(I);const _=I.filter(H=>typeof H.clienteId=="string"&&H.clienteId.toLowerCase().includes("cliente")||String(H.clienteId)===String(H._id));F(_),await Y(I)}catch(f){console.error("Error al cargar los beneficiarios:",f)}},Fe=async()=>{try{const f=await A.get(`${O}/matriculas`);N(f.data)}catch(f){console.error("Error al cargar las matrículas:",f)}},Y=async(f=null)=>{try{J(!0);const _=(await A.get(`${O}/ventas`)).data.filter(V=>V.tipo==="matricula"),H=f||M,Me=_.map(V=>{const ve=V.beneficiarioId;let we="No especificado",Pe="No especificado";if(ve){Pe=`${ve.nombre||""} ${ve.apellido||""}`.trim();const De=ve.clienteId,S=ve._id;if(String(De)===String(S))we=Pe;else{const j=H.find(Z=>String(Z._id)===String(De));j?we=`${j.nombre||""} ${j.apellido||""}`.trim():we=`Cliente ID: ${De}`}}return{id:V.codigoVenta||V._id,codigoVenta:V.codigoVenta||"",beneficiario:Pe,cliente:we,fechaInicio:new Date(V.fechaInicio).toLocaleDateString(),fechaFin:new Date(V.fechaFin).toLocaleDateString(),valorTotal:V.valor_total||0,estado:V.estado,motivoAnulacion:V.motivoAnulacion,fechaCreacion:V.createdAt?new Date(V.createdAt).toLocaleDateString():"",_original:V,beneficiarioObj:ve}});D(Me),m(Me)}catch(I){console.error("Error al cargar las matrículas:",I)}finally{J(!1)}},Ce=async()=>{try{const f=await A.get(`${O}/cursos`);re(f.data)}catch(f){console.error("Error al cargar los cursos:",f)}},so=[{id:"codigoVenta",label:"Código Venta"},{id:"beneficiario",label:"Beneficiario"},{id:"cliente",label:"Cliente"},{id:"fechaInicio",label:"Fecha Inicio"},{id:"fechaFin",label:"Fecha Fin"},{id:"valorTotal",label:"Valor Total",render:f=>`$${(f==null?void 0:f.toLocaleString())||0}`},{id:"estado",label:"Estado",filterOptions:[{value:"vigente",label:"Vigente"},{value:"anulada",label:"Anulada"}],render:(f,I)=>e.jsx(jo,{label:f==="vigente"?"Vigente":"Anulada",color:f==="vigente"?"success":"error",variant:"outlined",size:"small"})}],Ke=[{id:"cliente",label:"Cliente"},{id:"beneficiario",label:"Beneficiario"},{id:"fechaInicio",label:"Fecha Inicio"},{id:"fechaFin",label:"Fecha Fin"},{id:"valorTotal",label:"Valor Total",render:f=>`$${(f==null?void 0:f.toLocaleString())||0}`},{id:"estado",label:"Estado",render:f=>e.jsx(jo,{label:f==="vigente"?"Vigente":"Anulada",color:f==="vigente"?"success":"error",variant:"filled",size:"small"})},{id:"codigoVenta",label:"Código Venta"},{id:"motivoAnulacion",label:"Motivo Anulación"},{id:"fechaCreacion",label:"Fecha Creación"}],lo=()=>{ae(!1),W(null),p(!0)},eo=f=>{const I=x.find(_=>_.id===f.id);ee(I),ce(!0)},co=async()=>{if(s)try{await A.delete(`${O}/ventas/${s._original._id}`),Y(),ce(!1),ee(null),a("Matrícula eliminada exitosamente")}catch(f){console.error("Error al eliminar la matrícula:",f),n("Error al eliminar la matrícula")}},oo=f=>{const I=x.find(_=>_.id===f.id);W(I),de(!0)},uo=()=>{de(!1),W(null)},Ge=()=>{p(!1),W(null),ae(!1)},mo=async f=>{var I,_,H,Me,V,ve,we,Pe,De;try{const{matricula:S,beneficiario:j,usuarioBeneficiario:Z,cliente:T,clienteEsBeneficiario:R,curso:me,pago:L,isEditing:oe}=f;console.log("=== INICIANDO PROCESO DE VENTA ==="),console.log("Matricula:",JSON.stringify(S,null,2)),console.log("Pago:",JSON.stringify(L,null,2)),console.log("Curso:",JSON.stringify(me,null,2)),console.log("=====================================");let te=null,Le=null;if(oe&&((I=c==null?void 0:c.beneficiarioObj)!=null&&I._id))te=c.beneficiarioObj._id,await A.put(`${O}/beneficiarios/${te}`,{nombre:j.nombre,apellido:j.apellido,tipo_de_documento:j.tipoDocumento,numero_de_documento:j.numeroDocumento,telefono:j.telefono,direccion:j.direccion,fechaDeNacimiento:j.fechaNacimiento,correo:j.correo,estado:j.estado});else{let Q=null;R||(Q=$.find(E=>E.numero_de_documento===T.numeroDocumento&&!x.some(G=>{if(G._original.tipo!=="matricula"||G._original.estado!=="vigente")return!1;const Se=M.find(d=>String(d._id)===String(G._original.beneficiarioId));return Se?String(Se.clienteId)===String(E._id):!1})),Q?Le=Q._id:Le=(await A.post(`${O}/beneficiarios`,{nombre:T.nombre,apellido:T.apellido,tipo_de_documento:T.tipoDocumento,numero_de_documento:T.numeroDocumento,telefono:T.telefono,direccion:T.direccion,fechaDeNacimiento:T.fechaNacimiento,estado:T.estado,clienteId:"cliente"})).data._id);const ne=M.find(E=>E.numero_de_documento===j.numeroDocumento&&!x.some(G=>G._original.tipo==="matricula"&&G._original.estado==="vigente"&&String(G._original.beneficiarioId)===String(E._id)));if(ne)te=ne._id,R?await A.put(`${O}/beneficiarios/${te}`,{...ne,clienteId:te}):Le&&await A.put(`${O}/beneficiarios/${te}`,{...ne,clienteId:Le});else{let E=null,G=null;try{E=(await A.post(`${O}/usuarios`,{nombre:Z.nombre,apellido:Z.apellido,correo:Z.email,contrasena:Z.contrasena,documento:Z.documento,tipo_de_documento:j.tipoDocumento,telefono:j.telefono||Z.telefono,rol:"usuario",estado:!0})).data._id;const t=await A.get(`${O}/roles`),v=(Array.isArray(t.data.roles)?t.data.roles:t.data).find(z=>z.nombre.toLowerCase()==="beneficiario");if(!v)throw new Error('Rol "Beneficiario" no encontrado');const o=await A.post(`${O}/usuarios_has_rol`,{usuarioId:E,rolId:v._id});G=Array.isArray(o.data)?o.data[0]._id:o.data._id;const l={nombre:j.nombre,apellido:j.apellido,tipo_de_documento:j.tipoDocumento,numero_de_documento:j.numeroDocumento,telefono:j.telefono,direccion:j.direccion,fechaDeNacimiento:j.fechaNacimiento,correo:j.correo,estado:j.estado,usuario_has_rolId:G,clienteId:R?"cliente":Le};te=(await A.post(`${O}/beneficiarios`,l)).data._id;try{await A.post(`${O}/email/welcome`,{email:Z.email,nombre:Z.nombre,apellido:Z.apellido,username:Z.email,password:Z.contrasena}),console.log("Correo de bienvenida enviado correctamente")}catch(z){console.error("Error al enviar correo de bienvenida:",z)}R&&await A.put(`${O}/beneficiarios/${te}`,{clienteId:te})}catch(Se){throw console.error("Error al crear usuario/beneficiario:",(_=Se.response)==null?void 0:_.data),new Error("Error al crear el usuario/beneficiario: "+(((Me=(H=Se.response)==null?void 0:H.data)==null?void 0:Me.message)||"Error desconocido"))}}}const fe=b.find(Q=>Q._id===S.matriculaId);if(!fe)throw new Error("No se encontró la matrícula seleccionada");const ye=new Date,xe=new Date;xe.setFullYear(xe.getFullYear()+1);let $e=null,Ae=null;if(oe&&((V=c==null?void 0:c._original)!=null&&V._id)){const Q={tipo:"matricula",fechaInicio:ye,fechaFin:xe,estado:S.estado||"vigente",valor_total:Number.parseFloat(fe.valorMatricula||S.valorFinal||0),beneficiarioId:te,matriculaId:fe._id,observaciones:S.observaciones,descuento:Number.parseFloat(S.descuento||0)};await A.put(`${O}/ventas/${c._original._id}`,Q),$e=c._original._id,Ae=c._original.codigoVenta}else{const Q=await ho("matricula");Ae=`MA-${Q.toString().padStart(4,"0")}`;const ne={tipo:"matricula",fechaInicio:ye,fechaFin:xe,estado:S.estado||"vigente",valor_total:Number.parseFloat(fe.valorMatricula||S.valorFinal||0),beneficiarioId:te,matriculaId:fe._id,observaciones:S.observaciones,descuento:Number.parseFloat(S.descuento||0),consecutivo:Q,codigoVenta:Ae,metodoPago:(L==null?void 0:L.metodoPago)||"Efectivo",numeroTransaccion:(L==null?void 0:L.numeroTransaccion)||null,fechaPago:(L==null?void 0:L.fechaPago)||new Date().toISOString()};console.log("✅ Enviando venta de matrícula al middleware:"),console.log("  - Tipo:",ne.tipo),console.log("  - Método de pago:",ne.metodoPago);const E={"Content-Type":"application/json","x-skip-auto-payment":"false","x-skip-auto-counter":"true","x-source-module":"VentaMatriculas"};$e=(await A.post(`${O}/ventas`,ne,{headers:E,timeout:1e4})).data._id,console.log("✅ Venta de matrícula creada:",$e)}if(me&&me.curso&&!oe){console.log("=== CREANDO VENTA DE CURSO (COMPLETAMENTE AUTOMÁTICO) ===");const Q=P.find(t=>t.nombre===me.curso);if(!Q)throw new Error("No se encontró el curso seleccionado");const ne=await A.get(`${O}/ventas/next-consecutivo`);console.log("📊 Respuesta del consecutivo:",ne.data);const E=(ve=ne.data)==null?void 0:ve.nextConsecutivo;if(E==null||isNaN(E))throw new Error(`Error al obtener el consecutivo: ${JSON.stringify(ne.data)}`);const G={tipo:"curso",fechaInicio:S.fechaInicio,fechaFin:S.fechaFin,beneficiarioId:te,cursoId:Q._id,ciclo:me.ciclo||null,matriculaId:fe._id,numero_de_clases:Number.parseInt(me.clases),valor_total:Number.parseFloat(me.valorTotal),estado:"vigente",consecutivo:E,codigoVenta:`CU-${String(E).padStart(4,"0")}`,metodoPago:(L==null?void 0:L.metodoPago)||"Efectivo",numeroTransaccion:(L==null?void 0:L.numeroTransaccion)||null,fechaPago:(L==null?void 0:L.fechaPago)||new Date().toISOString()};console.log("✅ Enviando venta de curso:"),console.log("  - Consecutivo:",G.consecutivo),console.log("  - Código:",G.codigoVenta);const Se=await A.post(`${O}/ventas`,G,{timeout:1e4});console.log("✅ Venta de curso creada:",Se.data._id)}await X(),await Y(),Ge(),a("Matrícula y pago(s) guardados exitosamente")}catch(S){console.error("❌ ERROR GENERAL en handleSubmit:"),console.error("  - Mensaje:",S.message),console.error("  - Stack completo:",S.stack),S.response&&(console.error("  - Response status:",S.response.status),console.error("  - Response data:",JSON.stringify(S.response.data,null,2)),console.error("  - Response headers:",S.response.headers)),S.config&&(console.error("  - Request URL:",S.config.url),console.error("  - Request method:",S.config.method),console.error("  - Request data:",S.config.data),console.error("  - Request headers:",S.config.headers));let j="Error desconocido";S.message&&(j=S.message),((we=S.response)==null?void 0:we.status)===400&&(console.error("❌ Error 400 - Bad Request:"),console.error("  - Status:",S.response.status),console.error("  - Data:",S.response.data),console.error("  - Request data:",(Pe=S.config)==null?void 0:Pe.data),j=`Error 400: ${((De=S.response.data)==null?void 0:De.message)||"Solicitud inválida"}`),n("Error al guardar la matrícula: "+j)}},po=f=>{var _;const I=x.find(H=>H.id===f.id);if(((_=I==null?void 0:I.estado)==null?void 0:_.toLowerCase())==="anulada"){n("La matrícula ya está anulada");return}k(I),U(""),_e(!0)},fo=async()=>{var f,I;if(!u.trim()){n("Se requiere un motivo para anular la matrícula");return}if(r)try{const _={motivoAnulacion:u.trim()},H=await A.patch(`${O}/ventas/${r._original._id}/anular`,_);await Y(),_e(!1),k(null),U(""),a("Matrícula anulada exitosamente")}catch(_){console.error("Error al anular matrícula:",_);let H="Error desconocido al anular la matrícula";(I=(f=_.response)==null?void 0:f.data)!=null&&I.message?H=_.response.data.message:_.message&&(H=_.message),n(`Error al anular la matrícula: ${H}`)}},ho=async f=>{try{console.log(`=== INCREMENTANDO CONTADOR DE ${f.toUpperCase()} ===`);const _=(await A.patch(`${O}/contador/${f}/incrementar`)).data.contador.seq;return console.log(`✅ Contador de ${f.toUpperCase()} actualizado:`,_),_}catch(I){throw console.error(`❌ Error al incrementar contador de ${f.toUpperCase()}:`,I),I}};return e.jsxs(e.Fragment,{children:[e.jsx(Oo,{data:h,columns:so,onDelete:eo,onCreate:lo,onView:oo,title:"Gestión de Matrículas",loading:K,onCancel:po}),e.jsx(Bo,{title:`Detalle de Matrícula: ${c==null?void 0:c.beneficiario}`,data:c,fields:Ke,open:pe,onClose:uo,extraContent:(c==null?void 0:c.beneficiarioObj)&&e.jsxs(be,{sx:{mt:2},children:[e.jsx("strong",{children:"Datos del Beneficiario:"}),e.jsxs("div",{children:["Nombre: ",c.beneficiarioObj.nombre," ",c.beneficiarioObj.apellido]}),e.jsxs("div",{children:["Documento: ",c.beneficiarioObj.tipo_de_documento," ",c.beneficiarioObj.numero_de_documento]}),e.jsxs("div",{children:["Teléfono: ",c.beneficiarioObj.telefono]}),e.jsxs("div",{children:["Dirección: ",c.beneficiarioObj.direccion]}),e.jsxs("div",{children:["Fecha de Nacimiento: ",new Date(c.beneficiarioObj.fechaDeNacimiento).toLocaleDateString()]})]})}),e.jsx(jt,{open:le,onClose:Ge,onSubmit:mo,isEditing:y,clientes:$,beneficiarios:M,matriculas:b,cursosDisponibles:P,setClientes:F,setBeneficiarios:q,initialData:c,ventasOriginales:x}),e.jsx(Co,{open:ue,onClose:()=>ce(!1),onConfirm:co,title:"Confirmar Eliminación",content:`¿Está seguro de que desea eliminar la matrícula de ${s==null?void 0:s.beneficiario}? Esta acción no se puede deshacer.`,confirmButtonText:"Eliminar",confirmButtonColor:"#f44336",cancelButtonText:"Cancelar"}),e.jsx(Co,{open:io,onClose:()=>_e(!1),onConfirm:fo,title:"Confirmar Anulación",content:e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{marginBottom:12},children:["¿Está seguro de que desea anular la matrícula de ",e.jsx("b",{children:r==null?void 0:r.beneficiario}),"?"]}),e.jsx(w,{fullWidth:!0,label:"Motivo de anulación",multiline:!0,rows:3,value:u,onChange:f=>U(f.target.value),placeholder:"Ingrese el motivo por el cual se anula esta matrícula...",required:!0,error:u.trim()===""&&u!=="",helperText:u.trim()===""&&u!==""?"El motivo es requerido":"",sx:{mt:2}})]}),confirmButtonText:"Anular Matrícula",confirmButtonColor:"#ff9800",cancelButtonText:"Cancelar",confirmButtonDisabled:!u.trim()})]})};export{Rt as default};
