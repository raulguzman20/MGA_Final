import{g as ae,f as re,r as p,h as ne,_ as ie,j as a,s as se,i as U,k as le,l as ce,T as de,aQ as ue,a0 as me,a7 as pe,a2 as fe,a9 as he,b as M,E as l,a3 as be,A as ge}from"./index-D2WH0i0l.js";import{G as _e}from"./GenericList-CZICF8vs.js";import{D as De}from"./DetailModal-BVuqfkLW.js";import{F as Ce}from"./FormModal-BqkXggEq.js";import{S as Y}from"./StatusButton-T52DgIHd.js";import"./Search-CIHESQ8V.js";import"./NavigateNext-C2-Nd8B6.js";import"./TableRow-CTBWTERd.js";import"./Stack-BupWGgAE.js";import"./Checkbox-4ec6YfyB.js";import"./Switch-qiKByfkr.js";import"./FormControlLabel-CLvj0mWI.js";import"./EventNote-C1bQThfN.js";function xe(c){return ae("MuiDialogContentText",c)}re("MuiDialogContentText",["root"]);const ye=["children","className"],Ee=c=>{const{classes:f}=c,i=ce({root:["root"]},xe,f);return U({},f,i)},ve=se(de,{shouldForwardProp:c=>ue(c)||c==="classes",name:"MuiDialogContentText",slot:"Root",overridesResolver:(c,f)=>f.root})({}),Ne=p.forwardRef(function(f,r){const i=ne({props:f,name:"MuiDialogContentText"}),{className:D}=i,E=ie(i,ye),N=Ee(E);return a.jsx(ve,U({component:"p",variant:"body1",color:"text.secondary",ref:r,ownerState:E,className:le(N.root,D)},i,{classes:N}))}),we=({open:c,title:f,message:r,onClose:i,onConfirm:D})=>a.jsxs(me,{open:c,onClose:i,"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description",children:[a.jsx(pe,{id:"alert-dialog-title",children:f}),a.jsx(fe,{children:a.jsx(Ne,{id:"alert-dialog-description",children:r})}),a.jsx(he,{children:D?a.jsxs(a.Fragment,{children:[a.jsx(M,{onClick:i,color:"primary",children:"Cancelar"}),a.jsx(M,{onClick:D,color:"error",variant:"contained",autoFocus:!0,children:"Aceptar"})]}):a.jsx(M,{onClick:i,color:"primary",autoFocus:!0,children:"Aceptar"})})]}),Ye=()=>{const[c,f]=p.useState([]),[r,i]=p.useState(null),[D,E]=p.useState(!1),[N,T]=p.useState(!1),[Se,Fe]=p.useState({}),[u,R]=p.useState(!1),[w,g]=p.useState({open:!1,title:"",message:"",onConfirm:null}),[I,h]=p.useState({open:!1,message:"",severity:"success"}),z=e=>{if(!e)return"";const o=new Date(e),s=o.getFullYear(),d=String(o.getMonth()+1).padStart(2,"0"),_=String(o.getDate()).padStart(2,"0");return`${s}-${d}-${_}`};p.useEffect(()=>{S()},[]);const S=async()=>{try{const o=(await l.get("http://localhost:3000/api/beneficiarios")).data,d=(await l.get("http://localhost:3000/api/usuarios_has_rol")).data,b=o.filter(t=>t.clienteId===t._id||t.clienteId==="cliente").map(t=>{var F;const m=d.find(n=>n._id===t.usuario_has_rolId),$=((F=m==null?void 0:m.usuarioId)==null?void 0:F.correo)||"";return{id:t._id,nombre:t.nombre,apellido:t.apellido,tipoDocumento:t.tipo_de_documento,numeroDocumento:t.numero_de_documento,fechaNacimiento:t.fechaDeNacimiento,direccion:t.direccion,telefono:t.telefono,correo:$,esBeneficiario:t.esBeneficiario||!1,estado:t.estado!==void 0?t.estado:!0}});f(b)}catch(e){console.error("Error al obtener los clientes:",e)}},H=()=>{R(!1),i(null),T(!0)},G=e=>{try{if(!e){h({open:!0,message:"Error: No se pudo cargar el cliente para editar.",severity:"error"});return}R(!0);const o={id:e.id,nombre:e.nombre,apellido:e.apellido,tipo_de_documento:e.tipoDocumento,numero_de_documento:e.numeroDocumento,fechaDeNacimiento:z(e.fechaNacimiento),direccion:e.direccion,telefono:e.telefono,correo:e.correo,esBeneficiario:e.esBeneficiario||!1,estado:e.estado};i(o),T(!0)}catch(o){console.error("Error al editar cliente:",o),h({open:!0,message:"Error al cargar el formulario de edición.",severity:"error"})}},V=async e=>{var o,s,d,_;try{const{confirmar_contrasena:b,...t}=e;let m=String(t.numero_de_documento).replace(/\D/g,"");if(m.length<6||m.length>15){g({open:!0,title:"Error de validación",message:"El número de documento debe tener entre 6 y 15 dígitos.",onConfirm:null});return}if(!/^\d+$/.test(m)){g({open:!0,title:"Error de validación",message:"El número de documento debe contener solo números.",onConfirm:null});return}const $=new Date(t.fechaDeNacimiento),F=new Date().getFullYear();if($.getFullYear()>=F){g({open:!0,title:"Error de validación",message:"La fecha de nacimiento no puede ser del año actual o futuro.",onConfirm:null});return}if(!/^[0-9]{10}$/.test(t.telefono)){g({open:!0,title:"Error de validación",message:"El teléfono debe contener exactamente 10 dígitos numéricos.",onConfirm:null});return}if(t.numero_de_documento=m,u)try{await l.put(`http://localhost:3000/api/beneficiarios/${r.id}`,{nombre:t.nombre,apellido:t.apellido,tipo_de_documento:t.tipo_de_documento,numero_de_documento:m,fechaDeNacimiento:t.fechaDeNacimiento,direccion:t.direccion,telefono:t.telefono,correo:t.correo,esBeneficiario:t.esBeneficiario||!1});const n=await l.get(`http://localhost:3000/api/beneficiarios/${r.id}`),C=await l.get(`http://localhost:3000/api/usuarios_has_rol/${n.data.usuario_has_rolId}`),j=typeof C.data.usuarioId=="string"?C.data.usuarioId:(o=C.data.usuarioId)==null?void 0:o._id,v=await l.get(`http://localhost:3000/api/usuarios/${j}`),x=v.data.usuario||v.data,y={nombre:t.nombre,apellido:t.apellido,tipo_de_documento:t.tipo_de_documento,documento:m,correo:t.correo,estado:x.estado||!0};x.rol&&(y.rol=x.rol),t.contrasena&&(y.contrasena=t.contrasena),await l.put(`http://localhost:3000/api/usuarios/${j}`,y)}catch(n){throw console.error("Error al actualizar el cliente:",n),n}else{if(!t.contrasena||t.contrasena.length<8){g({open:!0,title:"Error de validación",message:"La contraseña debe tener al menos 8 caracteres y maximo 10.",onConfirm:null});return}const n={nombre:t.nombre.trim(),apellido:t.apellido.trim(),correo:t.correo.toLowerCase().trim(),contrasena:t.contrasena,tipo_de_documento:t.tipo_de_documento,documento:m,rol:"usuario"};console.log("Payload enviado a /usuarios:",n);const C=await l.post("http://localhost:3000/api/usuarios",n),j=C.data._id||((d=(s=C.data)==null?void 0:s.usuario)==null?void 0:d._id);try{await l.post("http://localhost:3000/api/email/welcome",{email:n.correo,nombre:n.nombre,apellido:n.apellido,username:n.correo,password:n.contrasena})}catch(A){console.error("Error al enviar correo de bienvenida:",A)}const v=await l.get("http://localhost:3000/api/roles"),x=v.data.roles||v.data||[],y=Array.isArray(x)?x.find(A=>A.nombre==="Cliente"):null;if(!y)throw new Error('Rol "Cliente" not found');const k=await l.post("http://localhost:3000/api/usuarios_has_rol",{usuarioId:j,rolId:y._id}),te=k.data._id||((_=k.data[0])==null?void 0:_._id),B={nombre:n.nombre,apellido:n.apellido,tipo_de_documento:n.tipo_de_documento,numero_de_documento:m,telefono:t.telefono,direccion:t.direccion,fechaDeNacimiento:t.fechaDeNacimiento,correo:n.correo,usuario_has_rolId:te,clienteId:"cliente",estado:!0};console.log("Payload enviado a /beneficiarios:",B);const O=await l.post("http://localhost:3000/api/beneficiarios",B);t.esBeneficiario&&await l.put(`http://localhost:3000/api/beneficiarios/${O.data._id}`,{clienteId:O.data._id})}S(),L(),h({open:!0,message:u?"Cliente actualizado correctamente.":"Cliente creado correctamente. Se ha enviado un correo de bienvenida.",severity:"success"})}catch(b){console.error("Error al guardar el cliente:",b),b.response?h({open:!0,message:`Error ${b.response.status}: ${b.response.data.message||"Error al guardar el cliente"}`,severity:"error"}):b.request?h({open:!0,message:"No se recibió respuesta del servidor. Verifique su conexión.",severity:"error"}):h({open:!0,message:`Error: ${b.message}`,severity:"error"})}},W=async e=>{g({open:!0,title:"Confirmar eliminación",message:`¿Está seguro de eliminar el cliente ${e.nombre}?`,onConfirm:()=>Q(e)})},Q=async e=>{g(o=>({...o,open:!1}));try{await l.delete(`http://localhost:3000/api/beneficiarios/${e.id}`),S(),h({open:!0,message:"Cliente eliminado correctamente.",severity:"success"})}catch(o){console.error("Error al eliminar el cliente:",o),o.response&&o.response.status===400?h({open:!0,message:"No se puede eliminar el cliente porque está asociado a una venta de curso o matrícula",severity:"error"}):h({open:!0,message:"Error al eliminar el cliente. Por favor, inténtelo de nuevo.",severity:"error"})}},Z=e=>{i(e),E(!0)},J=()=>{E(!1),i(null)},L=()=>{T(!1),i(null),R(!1)},K=e=>{if(!e)return 0;const o=new Date(e),s=new Date;let d=s.getFullYear()-o.getFullYear();const _=s.getMonth()-o.getMonth();return(_<0||_===0&&s.getDate()<o.getDate())&&d--,d},q=async e=>{try{const o=c.find(d=>d.id===e);if(!o)return;const s=!o.estado;await l.put(`http://localhost:3000/api/beneficiarios/${e}`,{...o,estado:s}),S()}catch(o){console.error("Error al actualizar el estado del cliente:",o)}},X=[{id:"nombre",label:"Nombre"},{id:"apellido",label:"Apellido"},{id:"tipoDocumento",label:"Tipo Documento"},{id:"numeroDocumento",label:"N° Documento"},{id:"fechaNacimiento",label:"Fecha Nacimiento"},{id:"direccion",label:"Dirección"},{id:"telefono",label:"Teléfono"},{id:"correo",label:"Correo"},{id:"estado",label:"Estado",render:(e,o)=>a.jsx(Y,{active:e,onClick:()=>q(o==null?void 0:o.id)})}],ee=[{id:"nombre",label:"Nombre"},{id:"apellido",label:"Apellido"},{id:"tipoDocumento",label:"Tipo de Documento"},{id:"numeroDocumento",label:"Número de Documento"},{id:"fechaNacimiento",label:"Fecha de Nacimiento"},{id:"direccion",label:"Dirección"},{id:"telefono",label:"Teléfono"},{id:"correo",label:"Correo Electrónico"},{id:"estado",label:"Estado",render:(e,o)=>a.jsx(Y,{active:e,onClick:()=>q(o==null?void 0:o.id)})}];p.useEffect(()=>{if(r&&r.fechaNacimiento){const e=K(r.fechaNacimiento);i(o=>({...o,age:e}))}},[r==null?void 0:r.fechaNacimiento]);const P=()=>{h(e=>({...e,open:!1}))},oe=()=>{g(e=>({...e,open:!1}))};return a.jsxs(a.Fragment,{children:[a.jsx(_e,{data:c,columns:X,onEdit:G,onDelete:W,onView:Z,onCreate:H,title:"Gestión de Clientes"}),a.jsx(De,{title:`Detalle del Cliente: ${r==null?void 0:r.nombre}`,data:r,fields:ee,open:D,onClose:J}),a.jsx(Ce,{open:N,onClose:L,onSubmit:V,initialData:r,isEditing:u,title:u?"Editar Cliente":"Crear Nuevo Cliente",fields:[{id:"nombre",label:"Nombre",type:"text",required:!0,section:"datos_personales"},{id:"apellido",label:"Apellido",type:"text",required:!0,section:"datos_personales"},{id:"correo",label:"Correo",type:"email",required:!0,section:"datos_contacto"},{id:"contrasena",label:"Contraseña",type:"password",required:!u,section:"datos_contacto",maxLength:10,validate:e=>{if(u&&!e)return null;if(!u||e){if(e.length>10)return"La contraseña no debe exceder los 10 caracteres";const o=/[A-Z]/.test(e),s=/[a-z]/.test(e),d=/[0-9]/.test(e);if(!o||!s||!d)return"La contraseña debe contener al menos una letra mayúscula, una minúscula, un número y maximo 10 caracteres"}return null},validateOnChange:!0,helperText:u?"Dejar en blanco para mantener la contraseña actual":""},{id:"confirmar_contrasena",label:"Confirmar Contraseña",type:"password",required:!u,section:"datos_contacto",maxLength:10,validate:(e,o)=>u&&!o.contrasena?null:!e&&(!u||o.contrasena)?"Debe confirmar la contraseña":e&&e!==o.contrasena?"Las contraseñas no coinciden":null,validateOnChange:!0,helperText:u?"Dejar en blanco si no cambia la contraseña":""},{id:"tipo_de_documento",label:"Tipo de Documento",type:"select",required:!0,section:"datos_personales",options:[{value:"TI",label:"TI"},{value:"CC",label:"CC"},{value:"CE",label:"CE"},{value:"PP",label:"PP"},{value:"NIT",label:"NIT"}]},{id:"numero_de_documento",label:"Número de Documento",type:"text",required:!0,section:"datos_personales",maxLength:10},{id:"telefono",label:"Teléfono",type:"text",required:!0,section:"datos_contacto",maxLength:10},{id:"direccion",label:"Dirección",type:"text",required:!0,section:"datos_contacto",maxLength:20},{id:"fechaDeNacimiento",label:"Fecha de Nacimiento",type:"date",required:!0,section:"datos_personales",validate:e=>{if(!e)return null;const o=new Date(e),s=new Date().getFullYear();return o.getFullYear()>=s?"La fecha de nacimiento no puede ser del año actual o futuro":null},validateOnChange:!0},{id:"esBeneficiario",label:"¿Es también beneficiario?",type:"checkbox",section:"datos_adicionales"}]}),a.jsx(we,{open:w.open,title:w.title,message:w.message,onClose:oe,onConfirm:w.onConfirm}),a.jsx(be,{open:I.open,autoHideDuration:6e3,onClose:P,anchorOrigin:{vertical:"bottom",horizontal:"right"},children:a.jsx(ge,{onClose:P,severity:I.severity,variant:"filled",sx:{minWidth:"250px",boxShadow:"0 2px 8px rgba(0,0,0,0.15)",borderRadius:"8px"},children:I.message})})]})};export{Ye as default};
