import{r as n,j as s,B as u,P as F,a3 as O,A as P,E as H,y as A}from"./index-D2WH0i0l.js";import{G as k}from"./GenericList-CZICF8vs.js";import{D as Y}from"./DetailModal-BVuqfkLW.js";import{S as z}from"./StatusButton-T52DgIHd.js";import{h as j}from"./es-DeJEf6oD.js";import"./Search-CIHESQ8V.js";import"./NavigateNext-C2-Nd8B6.js";import"./TableRow-CTBWTERd.js";import"./Stack-BupWGgAE.js";import"./EventNote-C1bQThfN.js";j.locale("es");const L={asistio:{label:"Asistió",color:"success"},no_asistio:{label:"No Asistió",color:"error"}},Z=()=>{const[$,p]=n.useState(!1),[C,y]=n.useState(null),[R,m]=n.useState(!0),[b,D]=n.useState([]),[c,d]=n.useState({open:!1,message:"",severity:"success"});n.useEffect(()=>{(async()=>{try{m(!0);const e=await H.get("http://localhost:3000/api/asistencias");D(e.data)}catch{d({open:!0,message:"Error al cargar los datos",severity:"error"})}finally{m(!1)}})()},[]);const E=n.useMemo(()=>{const r={};return b.forEach(e=>{var I,g,v,x,S;if(!e.ventaId||!e.programacionClaseId)return;const a=e.ventaId._id,o=(I=e.ventaId.beneficiarioId)==null?void 0:I._id,l=((g=e.ventaId.cursoId)==null?void 0:g._id)||e.ventaId.cursoId,t=(x=(v=e.programacionClaseId.programacionProfesor)==null?void 0:v.profesor)==null?void 0:x._id,i=e.programacionClaseId.horaInicio,h=e.programacionClaseId.horaFin,f=`${a}-${o}-${l}-${t}-${i}-${h}`;r[f]||(r[f]={ventaId:e.ventaId,beneficiario:e.ventaId.beneficiarioId,curso:e.ventaId.cursoId,profesor:(S=e.programacionClaseId.programacionProfesor)==null?void 0:S.profesor,horaInicio:i,horaFin:h,especialidad:e.programacionClaseId.especialidad,asistencias:[]}),r[f].asistencias.push(e)}),Object.values(r)},[b]),M=r=>{const e=L[r];return e?s.jsx(z,{status:r,label:e.label,color:e.color}):r},V=[{id:"beneficiario",label:"Beneficiario",render:(r,e)=>e.beneficiario?`${e.beneficiario.nombre||""} ${e.beneficiario.apellido||""}`.trim()||"Sin nombre":"Sin beneficiario"},{id:"curso",label:"Curso",render:(r,e)=>e.curso?typeof e.curso=="object"?e.curso.nombre:e.curso:"-"},{id:"profesor",label:"Profesor",render:(r,e)=>e.profesor?`${e.profesor.nombres||""} ${e.profesor.apellidos||""}`.trim()||"Sin nombre":"Sin profesor"},{id:"horario",label:"Horario",render:(r,e)=>`${e.horaInicio} - ${e.horaFin}`},{id:"asistidas",label:"Asistidas",render:(r,e)=>{const a=e.asistencias.filter(o=>o.estado==="asistio").length;return s.jsx(A,{label:a,color:"success",size:"small"})}},{id:"faltas",label:"Faltas",render:(r,e)=>{const a=e.asistencias.filter(o=>o.estado==="no_asistio").length;return s.jsx(A,{label:a,color:"error",size:"small"})}}],_=[{id:"beneficiario",label:"Beneficiario",render:(r,e)=>e.beneficiario?`${e.beneficiario.nombre||""} ${e.beneficiario.apellido||""}`.trim()||"Sin nombre":"Sin beneficiario"},{id:"codigoVenta",label:"Código Venta",render:(r,e)=>{var a;return((a=e.ventaId)==null?void 0:a.codigoVenta)||"-"}},{id:"curso",label:"Curso",render:(r,e)=>e.curso?typeof e.curso=="object"?e.curso.nombre:e.curso:"-"},{id:"profesor",label:"Profesor",render:(r,e)=>e.profesor?`${e.profesor.nombres||""} ${e.profesor.apellidos||""}`.trim()||"Sin nombre":"Sin profesor"},{id:"horario",label:"Horario",render:(r,e)=>`${e.horaInicio} - ${e.horaFin}`},{id:"especialidad",label:"Especialidad",render:(r,e)=>e.especialidad||"-"},{id:"historial",label:"Historial de Asistencias",render:(r,e)=>{if(e.asistencias.length===0)return"Sin registros";const a=e.asistencias.sort((o,l)=>{var t,i;return new Date(((t=l.programacionClaseId)==null?void 0:t.fecha)||l.createdAt)-new Date(((i=o.programacionClaseId)==null?void 0:i.fecha)||o.createdAt)});return s.jsx(u,{sx:{maxHeight:200,overflow:"auto"},children:a.map((o,l)=>{var i;const t=((i=o.programacionClaseId)==null?void 0:i.fecha)||o.createdAt;return s.jsxs(u,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:1,mb:.5,border:1,borderRadius:1,bgcolor:o.estado==="asistio"?"#f1f8e9":"#ffebee"},children:[s.jsx("span",{children:t?j(t).format("DD/MM/YYYY"):"-"}),M(o.estado),o.motivo&&s.jsxs("span",{style:{fontSize:12,color:"#888"},children:["Motivo: ",o.motivo]})]},l)})})}}],B=r=>{y(r),p(!0)};return s.jsxs(u,{sx:{height:"calc(100vh - 64px)",display:"flex",flexDirection:"column",gap:2},children:[s.jsx(F,{sx:{p:2,mb:2},children:s.jsx(k,{data:E,columns:V,onView:B,title:"Asistencias Agrupadas",showActions:!1,showViewButton:!0})}),s.jsx(Y,{title:"Detalle de Asistencia",data:C,fields:_,open:$,onClose:()=>p(!1)}),s.jsx(O,{open:c.open,autoHideDuration:6e3,onClose:()=>d({...c,open:!1}),children:s.jsx(P,{onClose:()=>d({...c,open:!1}),severity:c.severity,sx:{width:"100%"},children:c.message})})]})};export{Z as default};
