import{j as r,a0 as T,B as f,T as C,I as V,a1 as B,a2 as $,b as z,P as ae,r as y,E}from"./index-D2WH0i0l.js";import{G as le,F as ne}from"./formModal2-DqC9aShG.js";import{S as q}from"./StatusButton-T52DgIHd.js";import{S as de}from"./SuccessAlert-D_Anh4KD.js";import"./Search-CIHESQ8V.js";import"./NavigateNext-C2-Nd8B6.js";import"./TableRow-CTBWTERd.js";import"./Stack-BupWGgAE.js";import"./Checkbox-4ec6YfyB.js";import"./Switch-qiKByfkr.js";import"./FormControlLabel-CLvj0mWI.js";import"./EventNote-C1bQThfN.js";const ce=({open:P,onClose:j,title:h,data:x,fields:_,customContent:R})=>R?r.jsxs(T,{open:P,onClose:j,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{borderRadius:"12px",boxShadow:"0 4px 20px rgba(0, 0, 0, 0.08)",overflow:"hidden"}},children:[r.jsxs(f,{sx:{bgcolor:"#0455a2",color:"white",p:2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[r.jsx(C,{variant:"h6",sx:{fontWeight:600},children:h}),r.jsx(V,{onClick:j,sx:{color:"white"},children:r.jsx(B,{})})]}),r.jsx($,{sx:{p:0,maxHeight:"70vh",overflow:"auto",scrollbarWidth:"none","&::-webkit-scrollbar":{display:"none"},msOverflowStyle:"none"},children:R}),r.jsx(f,{sx:{p:2,display:"flex",justifyContent:"flex-end",bgcolor:"#f9f9f9"},children:r.jsx(z,{onClick:j,variant:"contained",disableElevation:!0,sx:{backgroundColor:"#0455a2",borderRadius:"8px",textTransform:"none",fontWeight:500,px:3,"&:hover":{backgroundColor:"#033b70"}},children:"Cerrar"})})]}):x?r.jsxs(T,{open:P,onClose:j,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{borderRadius:"8px",boxShadow:"0 4px 20px rgba(0, 0, 0, 0.08)",overflow:"hidden",width:"60%",height:"70%",maxHeight:"70vh"}},children:[r.jsxs(f,{sx:{bgcolor:"#0455a2",color:"white",p:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[r.jsx(C,{variant:"subtitle1",sx:{fontWeight:600,fontSize:"0.9rem"},children:h}),r.jsx(V,{onClick:j,sx:{color:"white",padding:.5},children:r.jsx(B,{fontSize:"small"})})]}),r.jsx($,{sx:{p:.5},children:r.jsx(f,{sx:{display:"grid",gridTemplateColumns:"1fr",gap:.25,"& .MuiTypography-root":{fontSize:"0.75rem"}},children:r.jsx(ae,{elevation:0,sx:{p:.5,border:"1px solid #e0e0e0",borderRadius:"8px",bgcolor:"#f8f9fa"},children:_==null?void 0:_.map(u=>r.jsxs(f,{sx:{display:"flex",borderBottom:"1px solid rgba(224, 224, 224, 0.5)",py:.5,"&:last-child":{borderBottom:"none"}},children:[r.jsx(f,{sx:{width:"30%",pr:.5,color:"text.secondary",fontWeight:500},children:u.label}),r.jsx(f,{sx:{flex:1},children:u.id==="viewPermissions"&&x[u.id]?r.jsx(f,{sx:{display:"flex",flexDirection:"column",gap:1},children:x[u.id].map(w=>r.jsxs(f,{sx:{p:1.5,bgcolor:"background.paper",borderRadius:1,border:"1px solid rgba(0, 0, 0, 0.12)"},children:[r.jsx(C,{variant:"subtitle2",sx:{mb:1,fontWeight:500},children:w.split("-").map(b=>b.charAt(0).toUpperCase()+b.slice(1)).join(" - ")}),r.jsx(f,{sx:{display:"flex",flexDirection:"column",gap:.5,pl:2},children:["Ver","Crear","Editar","Eliminar","Descargar"].map(b=>{var S;return r.jsx(f,{sx:{display:"flex",alignItems:"center",gap:1},children:(S=x.privileges)!=null&&S.some(v=>v.nombre_privilegio===b)?r.jsxs(C,{variant:"body2",sx:{color:"primary.main",display:"flex",alignItems:"center",gap:1},children:["✓ ",b]}):r.jsxs(C,{variant:"body2",sx:{color:"error.main",display:"flex",alignItems:"center",gap:1},children:["✗ ",b]})},`${w}-${b}`)})})]},w))}):u.render?typeof u.render=="function"?u.render(x[u.id],x):u.render:x[u.id]||"—"})]},u.id))})})}),r.jsx(f,{sx:{p:2,display:"flex",justifyContent:"flex-end",bgcolor:"#f9f9f9"},children:r.jsx(z,{onClick:j,variant:"contained",disableElevation:!0,size:"small",sx:{backgroundColor:"#0455a2",borderRadius:"8px",textTransform:"none",fontWeight:500,px:2,py:.5,"&:hover":{backgroundColor:"#033b70"}},children:"Cerrar"})})]}):null,we=()=>{const[P,j]=y.useState([]),[h,x]=y.useState(null),[_,R]=y.useState(!1),[u,w]=y.useState(!1),[b,S]=y.useState(!1),[v,L]=y.useState([]),[D,H]=y.useState([]),[U,F]=y.useState([]),[I,m]=y.useState({open:!1,message:""}),N=async()=>{try{const e=await E.get("http://localhost:3000/api/rol_permiso_privilegio?populate=rolId,permisoId,privilegioId");console.log("Relaciones rol-permiso-privilegio cargadas:",e.data),F(e.data)}catch(e){console.error("Error al cargar relaciones rol-permiso-privilegio:",e)}},G=(e,l,s)=>{console.log("=== TRANSFORMANDO PERMISOS ==="),console.log("Permisos del formulario:",e);const n=[],a=[];if(!Array.isArray(e))return console.error("permisosFormulario no es un array:",e),{permisosIds:[],privilegiosIds:[]};e.filter(i=>i.ver||i.crear||i.editar||i.eliminar||i.descargar).forEach(i=>{const g=l.find(t=>t.permiso===i.modulo||t.nombre===i.modulo);if(g!=null&&g._id){if(n.push(g._id),i.ver){const t=s.find(c=>c.nombre_privilegio==="Ver"||c.nombre==="Ver");t!=null&&t._id&&a.push(t._id)}if(i.crear){const t=s.find(c=>c.nombre_privilegio==="Crear"||c.nombre==="Crear");t!=null&&t._id&&a.push(t._id)}if(i.editar){const t=s.find(c=>c.nombre_privilegio==="Editar"||c.nombre==="Editar");t!=null&&t._id&&a.push(t._id)}if(i.eliminar){const t=s.find(c=>c.nombre_privilegio==="Eliminar"||c.nombre==="Eliminar");t!=null&&t._id&&a.push(t._id)}if(i.descargar){const t=s.find(c=>c.nombre_privilegio==="Descargar"||c.nombre==="Descargar"||c.nombre_privilegio==="Download"||c.nombre==="Download");t!=null&&t._id?a.push(t._id):console.warn('No se encontró el privilegio "Descargar" en la lista de privilegios disponibles')}}});const o=[...new Set(n)],d=[...new Set(a)];return{permisosIds:o,privilegiosIds:d}},W=e=>{const l=U.filter(n=>{var a;return((a=n.rolId)==null?void 0:a._id)===e||n.rolId===e}),s={};return l.forEach(n=>{var o;const a=((o=n.permisoId)==null?void 0:o._id)||n.permisoId,p=n.privilegioId;if(!s[a]){const d=v.find(i=>i._id===a);s[a]={permiso:d,privilegios:[]}}p&&s[a].privilegios.push(p)}),Object.values(s)},Y=e=>{if(!e||!e._id)return e;const l=W(e._id);console.log("Permisos y privilegios del rol:",l);const s={};l.forEach(a=>{var o,d;const p=((o=a.permiso)==null?void 0:o.permiso)||((d=a.permiso)==null?void 0:d.nombre);p&&(s[p]=a.privilegios.map(i=>i.nombre_privilegio||i.nombre))}),console.log("Mapa de permisos-privilegios:",s);const n=v.map(a=>{const p=a.permiso||a.nombre,o=s[p]||[];return console.log(`Módulo: ${p}, Privilegios: ${o.join(", ")}`),{modulo:p,ver:o.includes("Ver"),crear:o.includes("Crear"),editar:o.includes("Editar"),eliminar:o.includes("Eliminar"),descargar:o.includes("Descargar")||o.includes("Download")}});return console.log("Datos de permisos preparados para el formulario:",n),{...e,permisos:n}},A=async()=>{try{const e=await E.get("http://localhost:3000/api/roles?populate=permisos,privilegios");console.log("Roles cargados:",e.data),j(e.data.roles||e.data||[])}catch(e){console.error("Error al cargar roles:",e),m({open:!0,message:"Error al cargar los roles"})}},J=async()=>{try{const e=await E.get("http://localhost:3000/api/permisos");console.log("Permisos (módulos) cargados:",e.data),L(e.data)}catch(e){console.error("Error al cargar permisos:",e)}},X=async()=>{try{const e=await E.get("http://localhost:3000/api/privilegios");console.log("Privilegios (acciones) cargados:",e.data);const l=e.data.find(s=>s.nombre_privilegio==="Descargar"||s.nombre==="Descargar"||s.nombre_privilegio==="Download"||s.nombre==="Download");l?console.log('✅ Privilegio "Descargar" encontrado:',l):(console.warn('⚠️ ADVERTENCIA: No se encontró el privilegio "Descargar" en la base de datos'),console.log("Privilegios disponibles:",e.data.map(s=>s.nombre_privilegio||s.nombre))),H(e.data)}catch(e){console.error("Error al cargar privilegios:",e)}};y.useEffect(()=>{A(),J(),X(),N()},[]);const K=async e=>{var l,s;try{const n=P.find(o=>o._id===e);if(!n)return;const a=!n.estado;j(o=>o.map(d=>d._id===e?{...d,estado:a}:d));const p={nombre:n.nombre,descripcion:n.descripcion,estado:a,permisos:((l=n.permisos)==null?void 0:l.map(o=>o._id))||[],privilegios:((s=n.privilegios)==null?void 0:s.map(o=>o._id))||[]};await E.put(`http://localhost:3000/api/roles/${e}`,p),m({open:!0,message:"Estado actualizado correctamente"})}catch(n){A(),console.error("Error al actualizar estado del rol:",n),m({open:!0,message:"Error al actualizar el estado"})}},Q=async e=>{var l,s,n,a,p;try{if(console.log("=== INICIANDO ENVÍO DE FORMULARIO ==="),console.log("Datos del formulario recibidos:",JSON.stringify(e,null,2)),!e){m({open:!0,message:"No se recibieron datos del formulario"});return}const o=(l=e.nombre)==null?void 0:l.toString().trim(),d=(s=e.descripcion)==null?void 0:s.toString().trim();if(!o||o.length<3){m({open:!0,message:"El nombre es obligatorio y debe tener al menos 3 caracteres"});return}if(!d||d.length<10){m({open:!0,message:"La descripción es obligatoria y debe tener al menos 10 caracteres"});return}if(!e.permisos){m({open:!0,message:"Error: No se encontraron datos de permisos"});return}let i=[];if(Array.isArray(e.permisos))i=e.permisos;else if(typeof e.permisos=="object")i=Object.values(e.permisos);else{m({open:!0,message:"Error en la estructura de permisos"});return}if(console.log("Permisos como array:",i),!v||v.length===0){m({open:!0,message:"Error: No se han cargado los permisos disponibles"});return}if(!D||D.length===0){m({open:!0,message:"Error: No se han cargado los privilegios disponibles"});return}const{permisosIds:g,privilegiosIds:t}=G(i,v,D);if(g.length===0||t.length===0){m({open:!0,message:"Debe seleccionar al menos un permiso con sus privilegios"});return}const c={nombre:o,descripcion:d,estado:e.estado!==void 0?!!e.estado:!0,permisos:g,privilegios:t};console.log("Datos preparados para envío:",JSON.stringify(c,null,2));const k={headers:{"Content-Type":"application/json",Accept:"application/json"},timeout:1e4};let O;b&&(h!=null&&h._id)?(console.log("Actualizando rol existente..."),O=await E.put(`http://localhost:3000/api/roles/${h._id}`,c,k),m({open:!0,message:"Rol actualizado correctamente"})):(console.log("Creando nuevo rol..."),O=await E.post("http://localhost:3000/api/roles",c,k),m({open:!0,message:"Rol creado correctamente"})),console.log("Respuesta del servidor:",O.data),console.log("=== ENVÍO EXITOSO ==="),await A(),await N(),M()}catch(o){console.error("=== ERROR AL ENVIAR DATOS ==="),console.error("Error completo:",o);let d="Error al guardar el rol";o.code==="ECONNABORTED"?d="Tiempo de espera agotado. Verifique la conexión con el servidor.":o.response?(console.error("Status:",o.response.status),console.error("Datos del error:",o.response.data),o.response.status===400?(n=o.response.data)!=null&&n.message?d=`Error de validación: ${o.response.data.message}`:(a=o.response.data)!=null&&a.details?d=o.response.data.details:(p=o.response.data)!=null&&p.errors?d=`Errores de validación: ${Object.values(o.response.data.errors).join(", ")}`:d="Datos inválidos. Verifique la información ingresada.":o.response.status===409?d="Ya existe un rol con ese nombre.":o.response.status===500?d="Error interno del servidor.":d=`Error del servidor: ${o.response.status}`):o.request?d="No se pudo conectar con el servidor. Verifique que esté ejecutándose.":d=`Error de configuración: ${o.message}`,console.error("=== FIN ERROR ==="),m({open:!0,message:d})}},Z=e=>{S(!0);const l=Y(e);x(l),w(!0)},ee=e=>{x(e),R(!0)},re=()=>{R(!1),x(null)},M=()=>{w(!1),x(null),S(!1)},oe=()=>{m({...I,open:!1})},se=[{id:"nombre",label:"Nombre del Rol"},{id:"descripcion",label:"Descripción"},{id:"estado",label:"Estado",render:(e,l)=>r.jsx(q,{active:e===!0,onClick:()=>K(l._id)})}],ie=[{id:"nombre",label:"Nombre del Rol"},{id:"descripcion",label:"Descripción"},{id:"estado",label:"Estado",render:e=>r.jsx(q,{active:e===!0})},{id:"permisos_privilegios",label:"Permisos",render:(e,l)=>{if(!l._id)return"No hay permisos asignados";const s=W(l._id);return r.jsx("div",{style:{maxHeight:"70vh",overflowY:"auto"},children:r.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[r.jsx("thead",{children:r.jsxs("tr",{style:{backgroundColor:"#f8f9fa",borderBottom:"2px solid #dee2e6"},children:[r.jsx("th",{style:{padding:"12px",textAlign:"left",width:"280px"},children:"Módulo"}),r.jsx("th",{style:{padding:"12px",textAlign:"center",width:"120px"},children:"Ver"}),r.jsx("th",{style:{padding:"12px",textAlign:"center",width:"120px"},children:"Crear"}),r.jsx("th",{style:{padding:"12px",textAlign:"center",width:"120px"},children:"Editar"}),r.jsx("th",{style:{padding:"12px",textAlign:"center",width:"120px"},children:"Eliminar"}),r.jsx("th",{style:{padding:"12px",textAlign:"center",width:"120px"},children:"Descargar"})]})}),r.jsx("tbody",{children:v.map((n,a)=>{const p=s.find(i=>{var g;return((g=i.permiso)==null?void 0:g._id)===n._id}),o=(p==null?void 0:p.privilegios)||[],d=i=>o.some(g=>(g.nombre_privilegio||g.nombre)===i);return r.jsxs("tr",{style:{borderBottom:"1px solid #dee2e6"},children:[r.jsx("td",{style:{padding:"12px",color:"#2c3e50"},children:n.permiso||n.nombre}),["Ver","Crear","Editar","Eliminar","Descargar"].map((i,g)=>r.jsx("td",{style:{padding:"12px",textAlign:"center"},children:d(i)?r.jsx("span",{style:{color:"#2196f3",fontWeight:"bold"},children:"✓"}):r.jsx("span",{style:{color:"#e74c3c",fontWeight:"bold"},children:"✗"})},g))]},a)})})]})})}}],te=[{id:"nombre",label:"Nombre del Rol",type:"text",required:!0,disabled:b,minLength:3,maxLength:50,placeholder:"Ej: Administrador, Usuario, Editor"},{id:"descripcion",label:"Descripción",type:"text",required:!0,minLength:10,maxLength:200,placeholder:"Ej: Rol con acceso completo al sistema de administración"},{id:"permisos",label:"Permisos",type:"table",required:!0,tableConfig:{maxHeight:"70vh",modalSize:"fullscreen",minWidth:"100%",containerStyle:{padding:"20px",maxHeight:"70vh",overflowY:"auto",overflowX:"auto"}},columns:[{id:"modulo",label:"Módulo",width:"280px"},{id:"ver",label:"Ver",type:"checkbox",width:"120px"},{id:"crear",label:"Crear",type:"checkbox",width:"120px"},{id:"editar",label:"Editar",type:"checkbox",width:"120px"},{id:"eliminar",label:"Eliminar",type:"checkbox",width:"120px"},{id:"descargar",label:"Descargar",type:"checkbox",width:"120px"}],rows:v.length>0?v.map(e=>({modulo:e.permiso||e.nombre,ver:!1,crear:!1,editar:!1,eliminar:!1,descargar:!1})):[],validate:e=>!e||!Object.values(e).some(l=>l.ver||l.crear||l.editar||l.eliminar||l.descargar)?"Debe seleccionar al menos un permiso":null},{id:"estado",label:"Estado",type:"switch",defaultValue:!0}];return r.jsxs(r.Fragment,{children:[r.jsx(le,{data:P||[],columns:se,onEdit:Z,onView:ee,title:"Gestión de Roles"}),r.jsx(ce,{title:`Detalle del Rol ${(h==null?void 0:h.nombre)||""}`,data:h,fields:ie,open:_,onClose:re,modalProps:{maxWidth:!1,fullWidth:!0,PaperProps:{style:{width:"98vw",height:"98vh",maxWidth:"none",maxHeight:"none",margin:"1vh auto",borderRadius:"12px",padding:"0",overflow:"hidden"}}}}),r.jsx(ne,{title:b?"Editar Rol":"Crear Nuevo Rol",fields:te,initialData:h,open:u,onClose:M,onSubmit:Q,modalProps:{maxWidth:!1,fullWidth:!0,PaperProps:{style:{width:"98vw",height:"98vh",maxWidth:"none",maxHeight:"none",margin:"1vh auto",borderRadius:"12px",padding:"0",overflow:"hidden"}}}}),r.jsx(de,{open:I.open,message:I.message,onClose:oe})]})};export{we as default};
