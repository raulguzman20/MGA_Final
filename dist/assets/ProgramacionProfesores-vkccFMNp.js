import{p as be,r as f,j as o,B as c,T as x,a0 as U,I as je,a1 as ve,a2 as ye,G as B,D as Q,y as b,b as L,E as y,c as Ce}from"./index-D2WH0i0l.js";import{G as Se}from"./GenericList-CZICF8vs.js";import{S as Ee}from"./ScheduleModal-BhgwXoI-.js";import{S as Ie}from"./SuccessAlert-D_Anh4KD.js";import{C as Pe}from"./ConfirmationDialog-BkQTGDdL.js";import{T as $}from"./AccessTime-BdvwmUhM.js";import{C as De,a as we}from"./Search-CIHESQ8V.js";import"./NavigateNext-C2-Nd8B6.js";import"./TableRow-CTBWTERd.js";import"./Stack-BupWGgAE.js";import"./CalendarMonth-D4CxqV-i.js";import"./Add-BsbvM-9j.js";import"./InputAdornment-RiOQfDiX.js";const N={L:"Lunes",M:"Martes",X:"Miércoles",J:"Jueves",V:"Viernes",S:"Sábado",D:"Domingo"},ze=({active:m,onClick:C})=>o.jsx(L,{onClick:C,variant:"outlined",size:"small",startIcon:m?o.jsx(De,{}):o.jsx(we,{}),sx:{borderRadius:"16px",textTransform:"none",fontWeight:500,fontSize:"0.75rem",minWidth:"70px",height:"24px",px:1,borderColor:m?"#4caf50":"#f44336",color:m?"#4caf50":"#f44336",backgroundColor:"transparent","&:hover":{borderColor:m?"#388e3c":"#d32f2f",backgroundColor:m?"rgba(76, 175, 80, 0.04)":"rgba(244, 67, 54, 0.04)"},"& .MuiButton-startIcon":{marginRight:"2px","& svg":{fontSize:"14px"}}},children:m?"Activo":"Cancelado"}),Fe=()=>{var G;const{user:m}=be(),[C,V]=f.useState([]),[P,S]=f.useState([]),[g,Y]=f.useState(null),[Z,w]=f.useState(!1),[ee,z]=f.useState(!1),[d,A]=f.useState(null),[O,p]=f.useState({open:!1,message:""}),[oe,k]=f.useState(!1),[I,F]=f.useState(null),[re,_]=f.useState(!1),[E,J]=f.useState(null),[W,R]=f.useState(""),[T,M]=f.useState(!1),[se,H]=f.useState(!0),h=((G=m==null?void 0:m.role)==null?void 0:G.toLowerCase())==="profesor";console.log("Usuario actual:",m),f.useEffect(()=>{(async()=>{try{const a=(await y.get("http://localhost:3000/api/profesores")).data.map(t=>({id:String(t._id),nombre:`${t.nombres} ${t.apellidos}`,especialidad:t.especialidades&&t.especialidades.length>0?t.especialidades[0]:"Sin especialidad",color:t.color||"#0455a2"}));V(a),console.log("Profesores cargados:",a)}catch(r){console.error("Error al cargar profesores:",r),V([]),p({open:!0,message:"Error al cargar los profesores"})}})()},[]),f.useEffect(()=>{(async()=>{try{H(!0);let r="http://localhost:3000/api/programacion_de_profesores";if(h){const n=await y.get(`http://localhost:3000/api/profesores?usuarioId=${m.id}`);n.data&&n.data.length>0&&(r=`http://localhost:3000/api/programacion_de_profesores/profesor/${n.data[0]._id}`)}const a=await y.get(r);console.log("Respuesta de programaciones:",a.data);const t=a.data.map(n=>{let l;return typeof n.profesor=="object"&&n.profesor!==null?l=String(n.profesor._id||n.profesor.id):l=String(n.profesor),{...n,profesor:l}});S(t),console.log("Programaciones procesadas:",t)}catch(r){console.error("Error al cargar programaciones:",r),S([]),p({open:!0,message:"Error al cargar las programaciones"})}finally{H(!1)}})()},[h,m==null?void 0:m.id]);const ae=P.length>0&&C.length>0?P.map(e=>{const r=C.find(s=>{const i=typeof e.profesor=="object"&&e.profesor!==null?String(e.profesor._id||e.profesor.id):String(e.profesor);return String(s.id).trim()===i.trim()});if(!r)return console.warn("No se encontró profesor para programación:",{programacion:e,profesorBuscado:e.profesor,profesoresDisponibles:C.map(s=>({id:s.id,nombre:s.nombre}))}),null;const a=e.horariosPorDia||[],t=a.map(s=>s.dia);let n="",l="";if(a.length>0){const s=a.flatMap(i=>[i.horaInicio,i.horaFin]).filter(Boolean);s.length>0&&(n=s.reduce((i,j)=>j<i?j:i),l=s.reduce((i,j)=>j>i?j:i))}return{id:e._id,profesor:r.nombre,especialidad:r.especialidad,dias:t,horaInicio:n,horaFin:l,horariosPorDia:a,estado:e.estado||"activo",motivo:e.motivo||"",color:r.color,profesorId:r.id,fechaCreacion:e.createdAt,fechaActualizacion:e.updatedAt}}).filter(Boolean):[],te=[{id:"profesor",label:"Profesor",render:(e,r)=>o.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1},children:[o.jsx(Q,{sx:{color:r.color,fontSize:18}}),o.jsx("span",{children:e})]})},{id:"dias",label:"Días Disponibles",render:e=>{const r=["L","M","X","J","V","S","D"],a=["L","M","X","J","V"],t=["S","D"],n=["L","M","X","J","V","S"],l=[...e||[]].sort();return l.length===7&&l.every((s,i)=>s===r[i])?o.jsx(b,{label:"Todos los días",size:"small",color:"primary",sx:{fontSize:"0.75rem",fontWeight:500}}):l.length===5&&l.every((s,i)=>s===a[i])?o.jsx(b,{label:"Lun - Vie",size:"small",color:"info",sx:{fontSize:"0.75rem",fontWeight:500}}):l.length===2&&l.every((s,i)=>s===t[i])?o.jsx(b,{label:"Fin de semana",size:"small",color:"secondary",sx:{fontSize:"0.75rem",fontWeight:500}}):l.length===6&&l.every((s,i)=>s===n[i])?o.jsx(b,{label:"Lun - Sáb",size:"small",color:"info",sx:{fontSize:"0.75rem",fontWeight:500}}):o.jsxs(c,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:.5},children:[o.jsx(c,{sx:{display:"flex",flexWrap:"wrap",gap:.5,justifyContent:"center"},children:e==null?void 0:e.slice(0,4).map(s=>o.jsx(b,{label:N[s]||s,size:"small",color:"primary",sx:{fontSize:"0.75rem"}},s))}),(e==null?void 0:e.length)>4&&o.jsx(c,{sx:{display:"flex",flexWrap:"wrap",gap:.5,justifyContent:"center"},children:e==null?void 0:e.slice(4).map(s=>o.jsx(b,{label:N[s]||s,size:"small",color:"primary",sx:{fontSize:"0.75rem"}},s))})]})}},{id:"horaInicio",label:"Hora de Inicio",render:e=>o.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:.5,justifyContent:"center"},children:[o.jsx($,{sx:{fontSize:14,color:"text.secondary"}}),o.jsx(x,{variant:"body2",sx:{fontWeight:500},children:e})]})},{id:"horaFin",label:"Hora de Fin",render:e=>o.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:.5,justifyContent:"center"},children:[o.jsx($,{sx:{fontSize:14,color:"text.secondary"}}),o.jsx(x,{variant:"body2",sx:{fontWeight:500},children:e})]})},{id:"estado",label:"Estado",render:(e,r)=>o.jsx(ze,{active:e==="activo",onClick:()=>ue(r.id)}),filterOptions:[{value:"activo",label:"Activo"},{value:"cancelado",label:"Cancelado"}]}],ne=e=>{if(h){p({open:!0,message:"Los profesores no pueden editar programaciones"});return}M(!0),A({profesorId:e.profesorId,horariosPorDia:e.horariosPorDia,eventId:e.id,estado:e.estado,motivo:e.motivo||""}),z(!0)},ie=()=>{if(h){p({open:!0,message:"Los profesores no pueden crear programaciones"});return}console.log("Creando nueva programación - isEditing será false"),M(!1),A({profesorId:"",horariosPorDia:[],estado:"activo",motivo:""}),z(!0),console.log("Profesores disponibles para selección:",q.map(e=>({id:e.id,nombre:e.nombre,especialidad:e.especialidad})))},le=e=>{Y(e),w(!0)},ce=e=>{if(h){p({open:!0,message:"Los profesores no pueden eliminar programaciones"});return}F(e),k(!0)},de=e=>{if(h){p({open:!0,message:"Los profesores no pueden cancelar programaciones"});return}if(e.estado==="cancelado"){p({open:!0,message:"Esta programación ya está cancelada"});return}J(e),R(""),_(!0)},pe=async()=>{if(I)try{await y.delete(`http://localhost:3000/api/programacion_de_profesores/${I.id}`),S(e=>e.filter(r=>r._id!==I.id)),p({open:!0,message:"Programación eliminada correctamente"})}catch(e){console.error("Error al eliminar:",e),p({open:!0,message:"Error al eliminar la programación"})}finally{k(!1),F(null)}},fe=async()=>{if(!E||!W.trim()){p({open:!0,message:"Por favor, ingrese un motivo para la cancelación"});return}try{const e=P.find(r=>r._id===E.id);if(!e)return;await y.put(`http://localhost:3000/api/programacion_de_profesores/${E.id}`,{...e,estado:"cancelado",motivo:W}),S(r=>r.map(a=>a._id===E.id?{...a,estado:"cancelado",motivo:W}:a)),p({open:!0,message:"Programación cancelada correctamente"})}catch(e){console.error("Error al cancelar programación:",e),p({open:!0,message:"Error al cancelar la programación"})}finally{_(!1),J(null),R("")}},me=async e=>{var l,s,i,j,X,K;const{profesorId:r,horariosPorDia:a,motivo:t,estado:n}=e;console.log("=== INICIO handleScheduleSubmit ==="),console.log("Datos recibidos del modal:",e);try{if(T&&d){const u={profesor:r,horariosPorDia:a,estado:n||"activo",motivo:t||""};console.log("Enviando datos de actualización:",u),await y.put(`http://localhost:3000/api/programacion_de_profesores/${d.eventId}`,u),S(v=>v.map(D=>D._id===d.eventId?{...D,profesor:r,horariosPorDia:a,estado:n||"activo",motivo:t||""}:D)),p({open:!0,message:"Programación actualizada correctamente"})}else{const u={profesor:r,horariosPorDia:a,estado:"activo",motivo:t||""};console.log("=== DATOS FINALES PARA ENVÍO ==="),console.log("Objeto completo:",u),console.log("JSON stringificado:",JSON.stringify(u,null,2));const v=await y.post("http://localhost:3000/api/programacion_de_profesores",u);console.log("Respuesta del servidor:",v.data);const D={_id:v.data._id,profesor:r,horariosPorDia:a,estado:"activo",motivo:t||"",createdAt:v.data.createdAt,updatedAt:v.data.updatedAt};S(he=>[...he,D]),p({open:!0,message:"Programación creada correctamente"})}}catch(u){console.error("=== ERROR DETALLADO ==="),console.error("Error completo:",u),console.error("Status:",(l=u.response)==null?void 0:l.status),console.error("Status Text:",(s=u.response)==null?void 0:s.statusText),console.error("Respuesta del servidor:",(i=u.response)==null?void 0:i.data),console.error("Headers de respuesta:",(j=u.response)==null?void 0:j.headers),console.error("Config de la request:",u.config);const v=((K=(X=u.response)==null?void 0:X.data)==null?void 0:K.message)||u.message||"Error desconocido";p({open:!0,message:`Error al ${T?"actualizar":"crear"} la programación: ${v}`})}finally{z(!1),A(null),M(!1)}},ue=async e=>{try{const r=P.find(t=>t._id===e);if(!r)return;const a=r.estado==="activo"?"cancelado":"activo";await y.patch(`http://localhost:3000/api/programacion_de_profesores/${e}/estado`,{estado:a}),S(t=>t.map(n=>n._id===e?{...n,estado:a}:n)),p({open:!0,message:`Estado actualizado a ${a==="activo"?"activo":"cancelado"} correctamente`})}catch(r){console.error("Error updating status:",r),p({open:!0,message:"Error al actualizar el estado"})}},q=T?C:C.filter(e=>(d==null?void 0:d.profesorId)===e.id?!0:!P.some(r=>String(r.profesor).trim()===String(e.id).trim()&&r.estado==="activo")),xe=()=>{z(!1),A(null),M(!1)},ge=()=>o.jsxs(U,{open:re,onClose:()=>_(!1),maxWidth:"sm",fullWidth:!0,disableEscapeKeyDown:!0,closeAfterTransition:!0,slotProps:{backdrop:{onClick:()=>{}}},PaperProps:{sx:{borderRadius:"12px",boxShadow:"0 4px 20px rgba(0, 0, 0, 0.08)",overflow:"hidden"}},children:[o.jsx(c,{sx:{bgcolor:"#f44336",color:"white",p:2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:o.jsx(x,{variant:"h6",sx:{fontWeight:600},children:"Cancelar Programación"})}),o.jsxs(c,{sx:{p:3},children:[o.jsxs(x,{variant:"body1",sx:{mb:3},children:["¿Está seguro que desea cancelar la programación del profesor ",o.jsx("strong",{children:E==null?void 0:E.profesor}),"?"]}),o.jsx(Ce,{label:"Motivo de cancelación",fullWidth:!0,multiline:!0,rows:3,value:W,onChange:e=>R(e.target.value),sx:{mb:3},required:!0}),o.jsxs(c,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[o.jsx(L,{onClick:()=>_(!1),variant:"outlined",sx:{borderRadius:"8px",textTransform:"none",fontWeight:500,px:3,borderColor:"rgba(0, 0, 0, 0.12)"},children:"Cancelar"}),o.jsx(L,{onClick:fe,variant:"contained",color:"error",disableElevation:!0,sx:{borderRadius:"8px",textTransform:"none",fontWeight:500,px:3},children:"Confirmar Cancelación"})]})]})]});return se?o.jsx(c,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"400px"},children:o.jsx(x,{children:"Cargando programaciones..."})}):o.jsxs(c,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[o.jsx(Se,{title:"Programación de Profesores",data:ae,columns:te,onEdit:ne,onDelete:ce,onCancel:de,onCreate:h?null:ie,onView:le,showEditButton:!h,showDeleteButton:!h,showCancelButton:!h,showViewButton:!0}),o.jsxs(U,{open:Z,onClose:()=>w(!1),maxWidth:"md",fullWidth:!0,disableEscapeKeyDown:!0,closeAfterTransition:!0,slotProps:{backdrop:{onClick:()=>{}}},PaperProps:{sx:{borderRadius:"12px",boxShadow:"0 4px 20px rgba(0, 0, 0, 0.08)",overflow:"hidden"}},children:[o.jsxs(c,{sx:{bgcolor:"#0455a2",color:"white",p:2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[o.jsx(x,{variant:"h6",sx:{fontWeight:600},children:"Detalle de Programación"}),o.jsx(je,{onClick:()=>w(!1),sx:{color:"white"},children:o.jsx(ve,{})})]}),o.jsx(ye,{sx:{p:3},children:g&&o.jsxs(B,{container:!0,spacing:3,children:[o.jsxs(B,{item:!0,xs:12,md:6,children:[o.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[o.jsx(c,{sx:{width:12,height:12,borderRadius:"50%",bgcolor:g.color||"#0455a2"}}),o.jsx(Q,{sx:{color:g.color||"#0455a2"}}),o.jsx(x,{variant:"h6",sx:{fontWeight:600},children:g.profesor})]}),o.jsxs(x,{variant:"body1",sx:{mb:1},children:[o.jsx("strong",{children:"Especialidad:"})," ",g.especialidad]}),o.jsxs(x,{variant:"body1",sx:{mb:1},children:[o.jsx("strong",{children:"Estado:"})," ",g.estado==="activo"?o.jsx(b,{label:"Activo",color:"success",size:"small"}):o.jsx(b,{label:"Cancelado",color:"error",size:"small"})]}),o.jsxs(x,{variant:"body1",sx:{mb:1},children:[o.jsx("strong",{children:"Motivo/Observaciones:"})," ",g.motivo||"Sin observaciones"]}),o.jsxs(x,{variant:"body2",color:"text.secondary",children:[o.jsx("strong",{children:"Fecha de Creación:"})," ",g.fechaCreacion?new Date(g.fechaCreacion).toLocaleDateString("es-ES"):"N/A"]}),o.jsxs(x,{variant:"body2",color:"text.secondary",children:[o.jsx("strong",{children:"Última Actualización:"})," ",g.fechaActualizacion?new Date(g.fechaActualizacion).toLocaleDateString("es-ES"):"N/A"]})]}),o.jsxs(B,{item:!0,xs:12,md:6,children:[o.jsx(x,{variant:"h6",sx:{fontWeight:600,mb:2,color:"#0455a2"},children:"Horarios Configurados"}),g.horariosPorDia&&g.horariosPorDia.length>0?o.jsx(c,{sx:{display:"flex",flexDirection:"column",gap:1},children:g.horariosPorDia.map((e,r)=>o.jsxs(c,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:2,bgcolor:"#f8f9fa",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[o.jsx(c,{sx:{display:"flex",alignItems:"center",gap:1},children:o.jsx(b,{label:N[e.dia],size:"small",color:"primary",sx:{fontWeight:500,minWidth:"80px"}})}),o.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1},children:[o.jsx($,{sx:{fontSize:16,color:"text.secondary"}}),o.jsxs(x,{variant:"body2",sx:{fontWeight:500},children:[e.horaInicio," - ",e.horaFin]})]})]},r))}):o.jsx(x,{color:"text.secondary",children:"No hay horarios configurados"})]})]})}),o.jsx(c,{sx:{p:2,display:"flex",justifyContent:"flex-end",bgcolor:"#f9f9f9"},children:o.jsx(L,{onClick:()=>w(!1),variant:"contained",disableElevation:!0,sx:{backgroundColor:"#0455a2",borderRadius:"8px",textTransform:"none",fontWeight:500,px:3,"&:hover":{backgroundColor:"#033b70"}},children:"Cerrar"})})]}),o.jsx(Ee,{isOpen:ee,onClose:xe,onSubmit:me,profesores:q,defaultProfesorId:d==null?void 0:d.profesorId,defaultHorariosPorDia:d==null?void 0:d.horariosPorDia,defaultMotivo:d==null?void 0:d.motivo,defaultEstado:d==null?void 0:d.estado,isEditing:T}),o.jsx(Pe,{open:oe,title:"Confirmar Eliminación",content:`¿Está seguro que desea eliminar la programación del profesor ${I==null?void 0:I.profesor}?`,onConfirm:pe,onClose:()=>k(!1),confirmButtonColor:"#f44336",confirmButtonText:"Eliminar",disableEscapeKeyDown:!0,closeAfterTransition:!0,slotProps:{backdrop:{onClick:()=>{}}}}),ge(),o.jsx(Ie,{open:O.open,message:O.message,onClose:()=>p({...O,open:!1})})]})};export{Fe as default};
